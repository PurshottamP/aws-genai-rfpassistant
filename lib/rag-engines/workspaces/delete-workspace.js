"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DeleteWorkspace = void 0;
const cdk = require("aws-cdk-lib");
const iam = require("aws-cdk-lib/aws-iam");
const lambda = require("aws-cdk-lib/aws-lambda");
const logs = require("aws-cdk-lib/aws-logs");
const sfn = require("aws-cdk-lib/aws-stepfunctions");
const tasks = require("aws-cdk-lib/aws-stepfunctions-tasks");
const constructs_1 = require("constructs");
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
class DeleteWorkspace extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const deleteFunction = new lambda.Function(this, "DeleteWorkspaceFunction", {
            vpc: props.shared.vpc,
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/delete-workspace-workflow/delete")),
            runtime: props.shared.pythonRuntime,
            architecture: props.shared.lambdaArchitecture,
            handler: "index.lambda_handler",
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            timeout: cdk.Duration.minutes(15),
            logRetention: logs.RetentionDays.ONE_WEEK,
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                AURORA_DB_SECRET_ID: props.auroraPgVector?.database.secret
                    ?.secretArn,
                UPLOAD_BUCKET_NAME: props.dataImport.uploadBucket.bucketName,
                PROCESSING_BUCKET_NAME: props.dataImport.processingBucket.bucketName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables?.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables?.documentsByCompoundKeyIndexName ?? "",
                DOCUMENTS_BY_STATUS_INDEX: props.ragDynamoDBTables.documentsByStatusIndexName ?? "",
                DEFAULT_KENDRA_S3_DATA_SOURCE_BUCKET_NAME: props.kendraRetrieval?.kendraS3DataSourceBucket?.bucketName ?? "",
                OPEN_SEARCH_COLLECTION_ENDPOINT: props.openSearchVector?.openSearchCollectionEndpoint ?? "",
            },
        });
        if (props.auroraPgVector) {
            props.auroraPgVector.database.secret?.grantRead(deleteFunction);
            props.auroraPgVector.database.connections.allowDefaultPortFrom(deleteFunction);
        }
        if (props.openSearchVector) {
            deleteFunction.addToRolePolicy(new iam.PolicyStatement({
                actions: [
                    "aoss:APIAccessAll",
                    "aoss:DescribeIndex",
                    "aoss:DeleteIndex",
                ],
                resources: [props.openSearchVector.openSearchCollection.attrArn],
            }));
            props.openSearchVector.addToAccessPolicy("delete-workspace", [deleteFunction.role?.roleArn], [
                "aoss:DeleteIndex",
                "aoss:DescribeIndex",
                "aoss:ReadDocument",
                "aoss:WriteDocument",
            ]);
        }
        props.dataImport.uploadBucket.grantReadWrite(deleteFunction);
        props.dataImport.processingBucket.grantReadWrite(deleteFunction);
        props.kendraRetrieval?.kendraS3DataSourceBucket?.grantReadWrite(deleteFunction);
        props.ragDynamoDBTables.workspacesTable.grantReadWriteData(deleteFunction);
        props.ragDynamoDBTables.documentsTable.grantReadWriteData(deleteFunction);
        const handleError = new tasks.DynamoUpdateItem(this, "HandleError", {
            table: props.ragDynamoDBTables.workspacesTable,
            key: {
                workspace_id: tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt("$.workspace_id")),
                object_type: tasks.DynamoAttributeValue.fromString("workspace"),
            },
            updateExpression: "set #status = :error",
            expressionAttributeNames: {
                "#status": "status",
            },
            expressionAttributeValues: {
                ":error": tasks.DynamoAttributeValue.fromString("error"),
            },
        }).next(new sfn.Fail(this, "Fail", {
            cause: "Workspace deletion failed",
        }));
        const setDeleting = new tasks.DynamoUpdateItem(this, "SetDeleting", {
            table: props.ragDynamoDBTables.workspacesTable,
            key: {
                workspace_id: tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt("$.workspace_id")),
                object_type: tasks.DynamoAttributeValue.fromString("workspace"),
            },
            updateExpression: "set #status=:statusValue",
            expressionAttributeNames: {
                "#status": "status",
            },
            expressionAttributeValues: {
                ":statusValue": tasks.DynamoAttributeValue.fromString("deleting"),
            },
            resultPath: sfn.JsonPath.DISCARD,
        });
        const deleteTask = new tasks.LambdaInvoke(this, "Delete", {
            lambdaFunction: deleteFunction,
            resultPath: "$.deleteResult",
        }).addCatch(handleError, {
            errors: ["States.ALL"],
            resultPath: "$.deleteResult",
        });
        const workflow = setDeleting
            .next(deleteTask)
            .next(new sfn.Succeed(this, "Success"));
        const logGroup = new logs.LogGroup(this, "DeleteWorkspaceSMLogGroup", {
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
        });
        const stateMachine = new sfn.StateMachine(this, "DeleteWorkspace", {
            definitionBody: sfn.DefinitionBody.fromChainable(workflow),
            timeout: cdk.Duration.minutes(5),
            comment: "Delete Workspace Workflow",
            tracingEnabled: true,
            logs: {
                destination: logGroup,
                level: sfn.LogLevel.ALL,
            },
        });
        this.stateMachine = stateMachine;
    }
}
exports.DeleteWorkspace = DeleteWorkspace;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLXdvcmtzcGFjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRlbGV0ZS13b3Jrc3BhY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLDJDQUEyQztBQUMzQyxpREFBaUQ7QUFDakQsNkNBQTZDO0FBQzdDLHFEQUFxRDtBQUNyRCw2REFBNkQ7QUFDN0QsMkNBQXVDO0FBQ3ZDLDZCQUE2QjtBQVE3Qiw2Q0FBNEM7QUFZNUMsTUFBYSxlQUFnQixTQUFRLHNCQUFTO0lBRzVDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBMkI7UUFDbkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLGNBQWMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQ3hDLElBQUksRUFDSix5QkFBeUIsRUFDekI7WUFDRSxHQUFHLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHO1lBQ3JCLElBQUksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsOENBQThDLENBQUMsQ0FDckU7WUFDRCxPQUFPLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhO1lBQ25DLFlBQVksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLGtCQUFrQjtZQUM3QyxPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO1lBQ2hFLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsWUFBWSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUTtZQUN6QyxXQUFXLEVBQUU7Z0JBQ1gsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLDJCQUEyQjtnQkFD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LFdBQVcsRUFBRTtZQUN2QixNQUFNLEVBQUUsQ0FBQyxZQUFZLENBQUM7WUFDdEIsVUFBVSxFQUFFLGdCQUFnQjtTQUM3QixDQUFDLENBQUM7UUFFSCxNQUFNLFFBQVEsR0FBRyxXQUFXO2FBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUM7YUFDaEIsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUUxQyxNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLDJCQUEyQixFQUFFO1lBQ3BFLGFBQWEsRUFBRSwyQkFBYSxDQUFDLE9BQU87U0FDckMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRTtZQUNqRSxjQUFjLEVBQUUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDO1lBQzFELE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDaEMsT0FBTyxFQUFFLDJCQUEyQjtZQUNwQyxjQUFjLEVBQUUsSUFBSTtZQUNwQixJQUFJLEVBQUU7Z0JBQ0osV0FBVyxFQUFFLFFBQVE7Z0JBQ3JCLEtBQUssRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUc7YUFDeEI7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztJQUNuQyxDQUFDO0NBQ0Y7QUF2SkQsMENBdUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBzZm4gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zdGVwZnVuY3Rpb25zXCI7XG5pbXBvcnQgKiBhcyB0YXNrcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXN0ZXBmdW5jdGlvbnMtdGFza3NcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBTaGFyZWQgfSBmcm9tIFwiLi4vLi4vc2hhcmVkXCI7XG5pbXBvcnQgeyBTeXN0ZW1Db25maWcgfSBmcm9tIFwiLi4vLi4vc2hhcmVkL3R5cGVzXCI7XG5pbXBvcnQgeyBBdXJvcmFQZ1ZlY3RvciB9IGZyb20gXCIuLi9hdXJvcmEtcGd2ZWN0b3JcIjtcbmltcG9ydCB7IERhdGFJbXBvcnQgfSBmcm9tIFwiLi4vZGF0YS1pbXBvcnRcIjtcbmltcG9ydCB7IEtlbmRyYVJldHJpZXZhbCB9IGZyb20gXCIuLi9rZW5kcmEtcmV0cmlldmFsXCI7XG5pbXBvcnQgeyBPcGVuU2VhcmNoVmVjdG9yIH0gZnJvbSBcIi4uL29wZW5zZWFyY2gtdmVjdG9yXCI7XG5pbXBvcnQgeyBSYWdEeW5hbW9EQlRhYmxlcyB9IGZyb20gXCIuLi9yYWctZHluYW1vZGItdGFibGVzXCI7XG5pbXBvcnQgeyBSZW1vdmFsUG9saWN5IH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVsZXRlV29ya3NwYWNlUHJvcHMge1xuICByZWFkb25seSBjb25maWc6IFN5c3RlbUNvbmZpZztcbiAgcmVhZG9ubHkgc2hhcmVkOiBTaGFyZWQ7XG4gIHJlYWRvbmx5IGRhdGFJbXBvcnQ6IERhdGFJbXBvcnQ7XG4gIHJlYWRvbmx5IHJhZ0R5bmFtb0RCVGFibGVzOiBSYWdEeW5hbW9EQlRhYmxlcztcbiAgcmVhZG9ubHkgYXVyb3JhUGdWZWN0b3I/OiBBdXJvcmFQZ1ZlY3RvcjtcbiAgcmVhZG9ubHkgb3BlblNlYXJjaFZlY3Rvcj86IE9wZW5TZWFyY2hWZWN0b3I7XG4gIHJlYWRvbmx5IGtlbmRyYVJldHJpZXZhbD86IEtlbmRyYVJldHJpZXZhbDtcbn1cblxuZXhwb3J0IGNsYXNzIERlbGV0ZVdvcmtzcGFjZSBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBzdGF0ZU1hY2hpbmU/OiBzZm4uU3RhdGVNYWNoaW5lO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBEZWxldGVXb3Jrc3BhY2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBkZWxldGVGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJEZWxldGVXb3Jrc3BhY2VGdW5jdGlvblwiLFxuICAgICAge1xuICAgICAgICB2cGM6IHByb3BzLnNoYXJlZC52cGMsXG4gICAgICAgIGNvZGU6IHByb3BzLnNoYXJlZC5zaGFyZWRDb2RlLmJ1bmRsZVdpdGhMYW1iZGFBc3NldChcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4vZnVuY3Rpb25zL2RlbGV0ZS13b3Jrc3BhY2Utd29ya2Zsb3cvZGVsZXRlXCIpXG4gICAgICAgICksXG4gICAgICAgIHJ1bnRpbWU6IHByb3BzLnNoYXJlZC5weXRob25SdW50aW1lLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IHByb3BzLnNoYXJlZC5sYW1iZGFBcmNoaXRlY3R1cmUsXG4gICAgICAgIGhhbmRsZXI6IFwiaW5kZXgubGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgbGF5ZXJzOiBbcHJvcHMuc2hhcmVkLnBvd2VyVG9vbHNMYXllciwgcHJvcHMuc2hhcmVkLmNvbW1vbkxheWVyXSxcbiAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfV0VFSyxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAuLi5wcm9wcy5zaGFyZWQuZGVmYXVsdEVudmlyb25tZW50VmFyaWFibGVzLFxuICAgICAgICAgIEFVUk9SQV9EQl9TRUNSRVRfSUQ6IHByb3BzLmF1cm9yYVBnVmVjdG9yPy5kYXRhYmFzZS5zZWNyZXRcbiAgICAgICAgICAgID8uc2VjcmV0QXJuIGFzIHN0cmluZyxcbiAgICAgICAgICBVUExPQURfQlVDS0VUX05BTUU6IHByb3BzLmRhdGFJbXBvcnQudXBsb2FkQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgUFJPQ0VTU0lOR19CVUNLRVRfTkFNRTogcHJvcHMuZGF0YUltcG9ydC5wcm9jZXNzaW5nQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgV09SS1NQQUNFU19UQUJMRV9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICBXT1JLU1BBQ0VTX0JZX09CSkVDVF9UWVBFX0lOREVYX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy53b3Jrc3BhY2VzQnlPYmplY3RUeXBlSW5kZXhOYW1lLFxuICAgICAgICAgIERPQ1VNRU5UU19UQUJMRV9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXM/LmRvY3VtZW50c1RhYmxlLnRhYmxlTmFtZSA/PyBcIlwiLFxuICAgICAgICAgIERPQ1VNRU5UU19CWV9DT01QT1VORF9LRVlfSU5ERVhfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzPy5kb2N1bWVudHNCeUNvbXBvdW5kS2V5SW5kZXhOYW1lID8/IFwiXCIsXG4gICAgICAgICAgRE9DVU1FTlRTX0JZX1NUQVRVU19JTkRFWDpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c0J5U3RhdHVzSW5kZXhOYW1lID8/IFwiXCIsXG4gICAgICAgICAgREVGQVVMVF9LRU5EUkFfUzNfREFUQV9TT1VSQ0VfQlVDS0VUX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5rZW5kcmFSZXRyaWV2YWw/LmtlbmRyYVMzRGF0YVNvdXJjZUJ1Y2tldD8uYnVja2V0TmFtZSA/PyBcIlwiLFxuICAgICAgICAgIE9QRU5fU0VBUkNIX0NPTExFQ1RJT05fRU5EUE9JTlQ6XG4gICAgICAgICAgICBwcm9wcy5vcGVuU2VhcmNoVmVjdG9yPy5vcGVuU2VhcmNoQ29sbGVjdGlvbkVuZHBvaW50ID8/IFwiXCIsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIGlmIChwcm9wcy5hdXJvcmFQZ1ZlY3Rvcikge1xuICAgICAgcHJvcHMuYXVyb3JhUGdWZWN0b3IuZGF0YWJhc2Uuc2VjcmV0Py5ncmFudFJlYWQoZGVsZXRlRnVuY3Rpb24pO1xuICAgICAgcHJvcHMuYXVyb3JhUGdWZWN0b3IuZGF0YWJhc2UuY29ubmVjdGlvbnMuYWxsb3dEZWZhdWx0UG9ydEZyb20oXG4gICAgICAgIGRlbGV0ZUZ1bmN0aW9uXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5vcGVuU2VhcmNoVmVjdG9yKSB7XG4gICAgICBkZWxldGVGdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICBcImFvc3M6QVBJQWNjZXNzQWxsXCIsXG4gICAgICAgICAgICBcImFvc3M6RGVzY3JpYmVJbmRleFwiLFxuICAgICAgICAgICAgXCJhb3NzOkRlbGV0ZUluZGV4XCIsXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtwcm9wcy5vcGVuU2VhcmNoVmVjdG9yLm9wZW5TZWFyY2hDb2xsZWN0aW9uLmF0dHJBcm5dLFxuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgcHJvcHMub3BlblNlYXJjaFZlY3Rvci5hZGRUb0FjY2Vzc1BvbGljeShcbiAgICAgICAgXCJkZWxldGUtd29ya3NwYWNlXCIsXG4gICAgICAgIFtkZWxldGVGdW5jdGlvbi5yb2xlPy5yb2xlQXJuXSxcbiAgICAgICAgW1xuICAgICAgICAgIFwiYW9zczpEZWxldGVJbmRleFwiLFxuICAgICAgICAgIFwiYW9zczpEZXNjcmliZUluZGV4XCIsXG4gICAgICAgICAgXCJhb3NzOlJlYWREb2N1bWVudFwiLFxuICAgICAgICAgIFwiYW9zczpXcml0ZURvY3VtZW50XCIsXG4gICAgICAgIF1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcHJvcHMuZGF0YUltcG9ydC51cGxvYWRCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZGVsZXRlRnVuY3Rpb24pO1xuICAgIHByb3BzLmRhdGFJbXBvcnQucHJvY2Vzc2luZ0J1Y2tldC5ncmFudFJlYWRXcml0ZShkZWxldGVGdW5jdGlvbik7XG4gICAgcHJvcHMua2VuZHJhUmV0cmlldmFsPy5rZW5kcmFTM0RhdGFTb3VyY2VCdWNrZXQ/LmdyYW50UmVhZFdyaXRlKFxuICAgICAgZGVsZXRlRnVuY3Rpb25cbiAgICApO1xuICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoZGVsZXRlRnVuY3Rpb24pO1xuICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShkZWxldGVGdW5jdGlvbik7XG5cbiAgICBjb25zdCBoYW5kbGVFcnJvciA9IG5ldyB0YXNrcy5EeW5hbW9VcGRhdGVJdGVtKHRoaXMsIFwiSGFuZGxlRXJyb3JcIiwge1xuICAgICAgdGFibGU6IHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZSxcbiAgICAgIGtleToge1xuICAgICAgICB3b3Jrc3BhY2VfaWQ6IHRhc2tzLkR5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgc2ZuLkpzb25QYXRoLnN0cmluZ0F0KFwiJC53b3Jrc3BhY2VfaWRcIilcbiAgICAgICAgKSxcbiAgICAgICAgb2JqZWN0X3R5cGU6IHRhc2tzLkR5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXCJ3b3Jrc3BhY2VcIiksXG4gICAgICB9LFxuICAgICAgdXBkYXRlRXhwcmVzc2lvbjogXCJzZXQgI3N0YXR1cyA9IDplcnJvclwiLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgIFwiI3N0YXR1c1wiOiBcInN0YXR1c1wiLFxuICAgICAgfSxcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgXCI6ZXJyb3JcIjogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcImVycm9yXCIpLFxuICAgICAgfSxcbiAgICB9KS5uZXh0KFxuICAgICAgbmV3IHNmbi5GYWlsKHRoaXMsIFwiRmFpbFwiLCB7XG4gICAgICAgIGNhdXNlOiBcIldvcmtzcGFjZSBkZWxldGlvbiBmYWlsZWRcIixcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IHNldERlbGV0aW5nID0gbmV3IHRhc2tzLkR5bmFtb1VwZGF0ZUl0ZW0odGhpcywgXCJTZXREZWxldGluZ1wiLCB7XG4gICAgICB0YWJsZTogcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLFxuICAgICAga2V5OiB7XG4gICAgICAgIHdvcmtzcGFjZV9pZDogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcbiAgICAgICAgICBzZm4uSnNvblBhdGguc3RyaW5nQXQoXCIkLndvcmtzcGFjZV9pZFwiKVxuICAgICAgICApLFxuICAgICAgICBvYmplY3RfdHlwZTogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcIndvcmtzcGFjZVwiKSxcbiAgICAgIH0sXG4gICAgICB1cGRhdGVFeHByZXNzaW9uOiBcInNldCAjc3RhdHVzPTpzdGF0dXNWYWx1ZVwiLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgIFwiI3N0YXR1c1wiOiBcInN0YXR1c1wiLFxuICAgICAgfSxcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgXCI6c3RhdHVzVmFsdWVcIjogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcImRlbGV0aW5nXCIpLFxuICAgICAgfSxcbiAgICAgIHJlc3VsdFBhdGg6IHNmbi5Kc29uUGF0aC5ESVNDQVJELFxuICAgIH0pO1xuXG4gICAgY29uc3QgZGVsZXRlVGFzayA9IG5ldyB0YXNrcy5MYW1iZGFJbnZva2UodGhpcywgXCJEZWxldGVcIiwge1xuICAgICAgbGFtYmRhRnVuY3Rpb246IGRlbGV0ZUZ1bmN0aW9uLFxuICAgICAgcmVzdWx0UGF0aDogXCIkLmRlbGV0ZVJlc3VsdFwiLFxuICAgIH0pLmFkZENhdGNoKGhhbmRsZUVycm9yLCB7XG4gICAgICBlcnJvcnM6IFtcIlN0YXRlcy5BTExcIl0sXG4gICAgICByZXN1bHRQYXRoOiBcIiQuZGVsZXRlUmVzdWx0XCIsXG4gICAgfSk7XG5cbiAgICBjb25zdCB3b3JrZmxvdyA9IHNldERlbGV0aW5nXG4gICAgICAubmV4dChkZWxldGVUYXNrKVxuICAgICAgLm5leHQobmV3IHNmbi5TdWNjZWVkKHRoaXMsIFwiU3VjY2Vzc1wiKSk7XG5cbiAgICBjb25zdCBsb2dHcm91cCA9IG5ldyBsb2dzLkxvZ0dyb3VwKHRoaXMsIFwiRGVsZXRlV29ya3NwYWNlU01Mb2dHcm91cFwiLCB7XG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICBjb25zdCBzdGF0ZU1hY2hpbmUgPSBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCBcIkRlbGV0ZVdvcmtzcGFjZVwiLCB7XG4gICAgICBkZWZpbml0aW9uQm9keTogc2ZuLkRlZmluaXRpb25Cb2R5LmZyb21DaGFpbmFibGUod29ya2Zsb3cpLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICBjb21tZW50OiBcIkRlbGV0ZSBXb3Jrc3BhY2UgV29ya2Zsb3dcIixcbiAgICAgIHRyYWNpbmdFbmFibGVkOiB0cnVlLFxuICAgICAgbG9nczoge1xuICAgICAgICBkZXN0aW5hdGlvbjogbG9nR3JvdXAsXG4gICAgICAgIGxldmVsOiBzZm4uTG9nTGV2ZWwuQUxMLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc3RhdGVNYWNoaW5lID0gc3RhdGVNYWNoaW5lO1xuICB9XG59XG4iXX0=