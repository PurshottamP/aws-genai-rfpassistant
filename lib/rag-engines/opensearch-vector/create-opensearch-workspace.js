"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateOpenSearchWorkspace = void 0;
const cdk = require("aws-cdk-lib");
const iam = require("aws-cdk-lib/aws-iam");
const lambda = require("aws-cdk-lib/aws-lambda");
const logs = require("aws-cdk-lib/aws-logs");
const sfn = require("aws-cdk-lib/aws-stepfunctions");
const tasks = require("aws-cdk-lib/aws-stepfunctions-tasks");
const constructs_1 = require("constructs");
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
class CreateOpenSearchWorkspace extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const createFunction = new lambda.Function(this, "CreateOpenSearchWorkspaceFunction", {
            vpc: props.shared.vpc,
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/create-workflow/create")),
            runtime: props.shared.pythonRuntime,
            architecture: props.shared.lambdaArchitecture,
            handler: "index.lambda_handler",
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            timeout: cdk.Duration.minutes(5),
            logRetention: logs.RetentionDays.ONE_WEEK,
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                OPEN_SEARCH_COLLECTION_NAME: props.openSearchCollectionName,
                OPEN_SEARCH_COLLECTION_ENDPOINT: props.collectionEndpoint,
                OPEN_SEARCH_COLLECTION_ENDPOINT_PORT: "443",
            },
        });
        props.ragDynamoDBTables.workspacesTable.grantReadWriteData(createFunction);
        createFunction.addToRolePolicy(new iam.PolicyStatement({
            actions: [
                "aoss:APIAccessAll",
                "aoss:DescribeIndex",
                "aoss:CreateIndex",
            ],
            resources: [props.openSearchCollection.attrArn],
        }));
        const handleError = new tasks.DynamoUpdateItem(this, "HandleError", {
            table: props.ragDynamoDBTables.workspacesTable,
            key: {
                workspace_id: tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt("$.workspace_id")),
                object_type: tasks.DynamoAttributeValue.fromString("workspace"),
            },
            updateExpression: "set #status = :error",
            expressionAttributeNames: {
                "#status": "status",
            },
            expressionAttributeValues: {
                ":error": tasks.DynamoAttributeValue.fromString("error"),
            },
        }).next(new sfn.Fail(this, "Fail", {
            cause: "Workspace creation failed",
        }));
        const setCreating = new tasks.DynamoUpdateItem(this, "SetCreating", {
            table: props.ragDynamoDBTables.workspacesTable,
            key: {
                workspace_id: tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt("$.workspace_id")),
                object_type: tasks.DynamoAttributeValue.fromString("workspace"),
            },
            updateExpression: "set #status=:statusValue",
            expressionAttributeNames: {
                "#status": "status",
            },
            expressionAttributeValues: {
                ":statusValue": tasks.DynamoAttributeValue.fromString("creating"),
            },
            resultPath: sfn.JsonPath.DISCARD,
        });
        const setReady = new tasks.DynamoUpdateItem(this, "SetReady", {
            table: props.ragDynamoDBTables.workspacesTable,
            key: {
                workspace_id: tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt("$.workspace_id")),
                object_type: tasks.DynamoAttributeValue.fromString("workspace"),
            },
            updateExpression: "set #status=:statusValue",
            expressionAttributeNames: {
                "#status": "status",
            },
            expressionAttributeValues: {
                ":statusValue": tasks.DynamoAttributeValue.fromString("ready"),
            },
            resultPath: sfn.JsonPath.DISCARD,
        });
        const createTask = new tasks.LambdaInvoke(this, "Create", {
            lambdaFunction: createFunction,
            resultPath: "$.createResult",
        }).addCatch(handleError, {
            errors: ["States.ALL"],
            resultPath: "$.createResult",
        });
        const workflow = setCreating
            .next(createTask)
            .next(setReady)
            .next(new sfn.Succeed(this, "Success"));
        const logGroup = new logs.LogGroup(this, "CreateOpenSearchWorkspaceSMLogGroup", {
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
        });
        const stateMachine = new sfn.StateMachine(this, "CreateOpenSearchWorkspace", {
            definitionBody: sfn.DefinitionBody.fromChainable(workflow),
            timeout: cdk.Duration.minutes(5),
            comment: "Create OpenSearch Workspace Workflow",
            tracingEnabled: true,
            logs: {
                destination: logGroup,
                level: sfn.LogLevel.ALL,
            },
        });
        this.stateMachine = stateMachine;
        this.createWorkspaceRole = createFunction.role;
    }
}
exports.CreateOpenSearchWorkspace = CreateOpenSearchWorkspace;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLW9wZW5zZWFyY2gtd29ya3NwYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLW9wZW5zZWFyY2gtd29ya3NwYWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQywyQ0FBMkM7QUFDM0MsaURBQWlEO0FBQ2pELDZDQUE2QztBQUU3QyxxREFBcUQ7QUFDckQsNkRBQTZEO0FBQzdELDJDQUF1QztBQUN2Qyw2QkFBNkI7QUFJN0IsNkNBQTRDO0FBVzVDLE1BQWEseUJBQTBCLFNBQVEsc0JBQVM7SUFJdEQsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVBQ1YsS0FBcUM7UUFFckMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLGNBQWMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQ3hDLElBQUksRUFDSixtQ0FBbUMsRUFDbkM7WUFDRSxHQUFHLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHO1lBQ3JCLElBQUksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsb0NBQW9DLENBQUMsQ0FDM0Q7WUFDRCxPQUFPLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhO1lBQ25DLFlBQVksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLGtCQUFrQjtZQUM3QyxPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO1lBQ2hFLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDaEMsWUFBWSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUTtZQUN6QyxXQUFXLEVBQUU7Z0JBQ1gsR0FBRyxLQUFLLENB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aEMsT0FBTyxFQUFFLHNDQUFzQztZQUMvQyxjQUFjLEVBQUUsSUFBSTtZQUNwQixJQUFJLEVBQUU7Z0JBQ0osV0FBVyxFQUFFLFFBQVE7Z0JBQ3JCLEtBQUssRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUc7YUFDeEI7U0FDRixDQUNGLENBQUM7UUFFRixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQztJQUNqRCxDQUFDO0NBQ0Y7QUFsSkQsOERBa0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBvc3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1vcGVuc2VhcmNoc2VydmVybGVzc1wiO1xuaW1wb3J0ICogYXMgc2ZuIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3RlcGZ1bmN0aW9uc1wiO1xuaW1wb3J0ICogYXMgdGFza3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zdGVwZnVuY3Rpb25zLXRhc2tzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgU2hhcmVkIH0gZnJvbSBcIi4uLy4uL3NoYXJlZFwiO1xuaW1wb3J0IHsgU3lzdGVtQ29uZmlnIH0gZnJvbSBcIi4uLy4uL3NoYXJlZC90eXBlc1wiO1xuaW1wb3J0IHsgUmFnRHluYW1vREJUYWJsZXMgfSBmcm9tIFwiLi4vcmFnLWR5bmFtb2RiLXRhYmxlc1wiO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0ZU9wZW5TZWFyY2hXb3Jrc3BhY2VQcm9wcyB7XG4gIHJlYWRvbmx5IGNvbmZpZzogU3lzdGVtQ29uZmlnO1xuICByZWFkb25seSBzaGFyZWQ6IFNoYXJlZDtcbiAgcmVhZG9ubHkgcmFnRHluYW1vREJUYWJsZXM6IFJhZ0R5bmFtb0RCVGFibGVzO1xuICByZWFkb25seSBvcGVuU2VhcmNoQ29sbGVjdGlvbk5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgb3BlblNlYXJjaENvbGxlY3Rpb246IG9zcy5DZm5Db2xsZWN0aW9uO1xuICByZWFkb25seSBjb2xsZWN0aW9uRW5kcG9pbnQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENyZWF0ZU9wZW5TZWFyY2hXb3Jrc3BhY2UgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhdGVNYWNoaW5lOiBzZm4uU3RhdGVNYWNoaW5lO1xuICBwdWJsaWMgcmVhZG9ubHkgY3JlYXRlV29ya3NwYWNlUm9sZT86IGlhbS5JUm9sZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IENyZWF0ZU9wZW5TZWFyY2hXb3Jrc3BhY2VQcm9wc1xuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgY3JlYXRlRnVuY3Rpb24gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIFwiQ3JlYXRlT3BlblNlYXJjaFdvcmtzcGFjZUZ1bmN0aW9uXCIsXG4gICAgICB7XG4gICAgICAgIHZwYzogcHJvcHMuc2hhcmVkLnZwYyxcbiAgICAgICAgY29kZTogcHJvcHMuc2hhcmVkLnNoYXJlZENvZGUuYnVuZGxlV2l0aExhbWJkYUFzc2V0KFxuICAgICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi9mdW5jdGlvbnMvY3JlYXRlLXdvcmtmbG93L2NyZWF0ZVwiKVxuICAgICAgICApLFxuICAgICAgICBydW50aW1lOiBwcm9wcy5zaGFyZWQucHl0aG9uUnVudGltZSxcbiAgICAgICAgYXJjaGl0ZWN0dXJlOiBwcm9wcy5zaGFyZWQubGFtYmRhQXJjaGl0ZWN0dXJlLFxuICAgICAgICBoYW5kbGVyOiBcImluZGV4LmxhbWJkYV9oYW5kbGVyXCIsXG4gICAgICAgIGxheWVyczogW3Byb3BzLnNoYXJlZC5wb3dlclRvb2xzTGF5ZXIsIHByb3BzLnNoYXJlZC5jb21tb25MYXllcl0sXG4gICAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxuICAgICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfV0VFSyxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAuLi5wcm9wcy5zaGFyZWQuZGVmYXVsdEVudmlyb25tZW50VmFyaWFibGVzLFxuICAgICAgICAgIFdPUktTUEFDRVNfVEFCTEVfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgV09SS1NQQUNFU19CWV9PQkpFQ1RfVFlQRV9JTkRFWF9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc0J5T2JqZWN0VHlwZUluZGV4TmFtZSxcbiAgICAgICAgICBPUEVOX1NFQVJDSF9DT0xMRUNUSU9OX05BTUU6IHByb3BzLm9wZW5TZWFyY2hDb2xsZWN0aW9uTmFtZSxcbiAgICAgICAgICBPUEVOX1NFQVJDSF9DT0xMRUNUSU9OX0VORFBPSU5UOiBwcm9wcy5jb2xsZWN0aW9uRW5kcG9pbnQsXG4gICAgICAgICAgT1BFTl9TRUFSQ0hfQ09MTEVDVElPTl9FTkRQT0lOVF9QT1JUOiBcIjQ0M1wiLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG5cbiAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy53b3Jrc3BhY2VzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKGNyZWF0ZUZ1bmN0aW9uKTtcbiAgICBjcmVhdGVGdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcImFvc3M6QVBJQWNjZXNzQWxsXCIsXG4gICAgICAgICAgXCJhb3NzOkRlc2NyaWJlSW5kZXhcIixcbiAgICAgICAgICBcImFvc3M6Q3JlYXRlSW5kZXhcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMub3BlblNlYXJjaENvbGxlY3Rpb24uYXR0ckFybl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBoYW5kbGVFcnJvciA9IG5ldyB0YXNrcy5EeW5hbW9VcGRhdGVJdGVtKHRoaXMsIFwiSGFuZGxlRXJyb3JcIiwge1xuICAgICAgdGFibGU6IHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZSxcbiAgICAgIGtleToge1xuICAgICAgICB3b3Jrc3BhY2VfaWQ6IHRhc2tzLkR5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgc2ZuLkpzb25QYXRoLnN0cmluZ0F0KFwiJC53b3Jrc3BhY2VfaWRcIilcbiAgICAgICAgKSxcbiAgICAgICAgb2JqZWN0X3R5cGU6IHRhc2tzLkR5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXCJ3b3Jrc3BhY2VcIiksXG4gICAgICB9LFxuICAgICAgdXBkYXRlRXhwcmVzc2lvbjogXCJzZXQgI3N0YXR1cyA9IDplcnJvclwiLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgIFwiI3N0YXR1c1wiOiBcInN0YXR1c1wiLFxuICAgICAgfSxcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgXCI6ZXJyb3JcIjogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcImVycm9yXCIpLFxuICAgICAgfSxcbiAgICB9KS5uZXh0KFxuICAgICAgbmV3IHNmbi5GYWlsKHRoaXMsIFwiRmFpbFwiLCB7XG4gICAgICAgIGNhdXNlOiBcIldvcmtzcGFjZSBjcmVhdGlvbiBmYWlsZWRcIixcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IHNldENyZWF0aW5nID0gbmV3IHRhc2tzLkR5bmFtb1VwZGF0ZUl0ZW0odGhpcywgXCJTZXRDcmVhdGluZ1wiLCB7XG4gICAgICB0YWJsZTogcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLFxuICAgICAga2V5OiB7XG4gICAgICAgIHdvcmtzcGFjZV9pZDogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcbiAgICAgICAgICBzZm4uSnNvblBhdGguc3RyaW5nQXQoXCIkLndvcmtzcGFjZV9pZFwiKVxuICAgICAgICApLFxuICAgICAgICBvYmplY3RfdHlwZTogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcIndvcmtzcGFjZVwiKSxcbiAgICAgIH0sXG4gICAgICB1cGRhdGVFeHByZXNzaW9uOiBcInNldCAjc3RhdHVzPTpzdGF0dXNWYWx1ZVwiLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgIFwiI3N0YXR1c1wiOiBcInN0YXR1c1wiLFxuICAgICAgfSxcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgXCI6c3RhdHVzVmFsdWVcIjogdGFza3MuRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcImNyZWF0aW5nXCIpLFxuICAgICAgfSxcbiAgICAgIHJlc3VsdFBhdGg6IHNmbi5Kc29uUGF0aC5ESVNDQVJELFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2V0UmVhZHkgPSBuZXcgdGFza3MuRHluYW1vVXBkYXRlSXRlbSh0aGlzLCBcIlNldFJlYWR5XCIsIHtcbiAgICAgIHRhYmxlOiBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy53b3Jrc3BhY2VzVGFibGUsXG4gICAgICBrZXk6IHtcbiAgICAgICAgd29ya3NwYWNlX2lkOiB0YXNrcy5EeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgIHNmbi5Kc29uUGF0aC5zdHJpbmdBdChcIiQud29ya3NwYWNlX2lkXCIpXG4gICAgICAgICksXG4gICAgICAgIG9iamVjdF90eXBlOiB0YXNrcy5EeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFwid29ya3NwYWNlXCIpLFxuICAgICAgfSxcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb246IFwic2V0ICNzdGF0dXM9OnN0YXR1c1ZhbHVlXCIsXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgXCIjc3RhdHVzXCI6IFwic3RhdHVzXCIsXG4gICAgICB9LFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICBcIjpzdGF0dXNWYWx1ZVwiOiB0YXNrcy5EeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFwicmVhZHlcIiksXG4gICAgICB9LFxuICAgICAgcmVzdWx0UGF0aDogc2ZuLkpzb25QYXRoLkRJU0NBUkQsXG4gICAgfSk7XG5cbiAgICBjb25zdCBjcmVhdGVUYXNrID0gbmV3IHRhc2tzLkxhbWJkYUludm9rZSh0aGlzLCBcIkNyZWF0ZVwiLCB7XG4gICAgICBsYW1iZGFGdW5jdGlvbjogY3JlYXRlRnVuY3Rpb24sXG4gICAgICByZXN1bHRQYXRoOiBcIiQuY3JlYXRlUmVzdWx0XCIsXG4gICAgfSkuYWRkQ2F0Y2goaGFuZGxlRXJyb3IsIHtcbiAgICAgIGVycm9yczogW1wiU3RhdGVzLkFMTFwiXSxcbiAgICAgIHJlc3VsdFBhdGg6IFwiJC5jcmVhdGVSZXN1bHRcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IHdvcmtmbG93ID0gc2V0Q3JlYXRpbmdcbiAgICAgIC5uZXh0KGNyZWF0ZVRhc2spXG4gICAgICAubmV4dChzZXRSZWFkeSlcbiAgICAgIC5uZXh0KG5ldyBzZm4uU3VjY2VlZCh0aGlzLCBcIlN1Y2Nlc3NcIikpO1xuXG4gICAgY29uc3QgbG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cChcbiAgICAgIHRoaXMsXG4gICAgICBcIkNyZWF0ZU9wZW5TZWFyY2hXb3Jrc3BhY2VTTUxvZ0dyb3VwXCIsXG4gICAgICB7XG4gICAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lID0gbmV3IHNmbi5TdGF0ZU1hY2hpbmUoXG4gICAgICB0aGlzLFxuICAgICAgXCJDcmVhdGVPcGVuU2VhcmNoV29ya3NwYWNlXCIsXG4gICAgICB7XG4gICAgICAgIGRlZmluaXRpb25Cb2R5OiBzZm4uRGVmaW5pdGlvbkJvZHkuZnJvbUNoYWluYWJsZSh3b3JrZmxvdyksXG4gICAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxuICAgICAgICBjb21tZW50OiBcIkNyZWF0ZSBPcGVuU2VhcmNoIFdvcmtzcGFjZSBXb3JrZmxvd1wiLFxuICAgICAgICB0cmFjaW5nRW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgbG9nczoge1xuICAgICAgICAgIGRlc3RpbmF0aW9uOiBsb2dHcm91cCxcbiAgICAgICAgICBsZXZlbDogc2ZuLkxvZ0xldmVsLkFMTCxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmUgPSBzdGF0ZU1hY2hpbmU7XG4gICAgdGhpcy5jcmVhdGVXb3Jrc3BhY2VSb2xlID0gY3JlYXRlRnVuY3Rpb24ucm9sZTtcbiAgfVxufVxuIl19