"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileImportBatchJob = void 0;
const cdk = require("aws-cdk-lib");
const constructs_1 = require("constructs");
const batch = require("aws-cdk-lib/aws-batch");
const ecs = require("aws-cdk-lib/aws-ecs");
const ec2 = require("aws-cdk-lib/aws-ec2");
const aws_ecr_assets = require("aws-cdk-lib/aws-ecr-assets");
const iam = require("aws-cdk-lib/aws-iam");
const cdk_nag_1 = require("cdk-nag");
class FileImportBatchJob extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const computeEnvironment = new batch.ManagedEc2EcsComputeEnvironment(this, "ManagedEc2EcsComputeEnvironment", {
            vpc: props.shared.vpc,
            instanceTypes: [
                ec2.InstanceType.of(ec2.InstanceClass.M6A, ec2.InstanceSize.LARGE),
            ],
            maxvCpus: 4,
            minvCpus: 0,
            replaceComputeEnvironment: true,
            updateTimeout: cdk.Duration.minutes(30),
            updateToLatestImageVersion: true,
        });
        const jobQueue = new batch.JobQueue(this, "JobQueue", {
            computeEnvironments: [
                {
                    computeEnvironment,
                    order: 1,
                },
            ],
            priority: 1,
        });
        const fileImportJobRole = new iam.Role(this, "FileImportJobRole", {
            assumedBy: new iam.ServicePrincipal("ecs-tasks.amazonaws.com"),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonECSTaskExecutionRolePolicy"),
            ],
        });
        const fileImportContainer = new batch.EcsEc2ContainerDefinition(this, "FileImportContainer", {
            cpu: 2,
            memory: cdk.Size.mebibytes(2048),
            image: ecs.ContainerImage.fromAsset("lib/shared", {
                platform: aws_ecr_assets.Platform.LINUX_AMD64,
                file: "file-import-dockerfile",
            }),
            jobRole: fileImportJobRole,
            environment: {
                AWS_DEFAULT_REGION: cdk.Stack.of(this).region,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                API_KEYS_SECRETS_ARN: props.shared.apiKeysSecret.secretArn,
                AURORA_DB_SECRET_ID: props.auroraDatabase?.secret
                    ?.secretArn,
                PROCESSING_BUCKET_NAME: props.processingBucket.bucketName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables.documentsByCompoundKeyIndexName ?? "",
                SAGEMAKER_RAG_MODELS_ENDPOINT: props.sageMakerRagModelsEndpoint?.attrEndpointName ?? "",
                OPEN_SEARCH_COLLECTION_ENDPOINT: props.openSearchVector?.openSearchCollectionEndpoint ?? "",
            },
        });
        const fileImportJob = new batch.EcsJobDefinition(this, "FileImportJob", {
            container: fileImportContainer,
            timeout: cdk.Duration.minutes(30),
            retryAttempts: 3,
            retryStrategies: [
                batch.RetryStrategy.of(batch.Action.EXIT, batch.Reason.CANNOT_PULL_CONTAINER),
                batch.RetryStrategy.of(batch.Action.EXIT, batch.Reason.custom({
                    onExitCode: "137",
                })),
            ],
        });
        props.uploadBucket.grantReadWrite(fileImportJobRole);
        props.processingBucket.grantReadWrite(fileImportJobRole);
        props.shared.configParameter.grantRead(fileImportJobRole);
        props.shared.apiKeysSecret.grantRead(fileImportJobRole);
        props.ragDynamoDBTables.workspacesTable.grantReadWriteData(fileImportJobRole);
        props.ragDynamoDBTables.documentsTable.grantReadWriteData(fileImportJobRole);
        if (props.auroraDatabase) {
            props.auroraDatabase.secret?.grantRead(fileImportJobRole);
            props.auroraDatabase.connections.allowDefaultPortFrom(computeEnvironment);
        }
        if (props.openSearchVector) {
            fileImportJobRole.addToPolicy(new iam.PolicyStatement({
                actions: ["aoss:APIAccessAll"],
                resources: [props.openSearchVector.openSearchCollection.attrArn],
            }));
            props.openSearchVector.addToAccessPolicy("file-import-job", [fileImportJobRole.roleArn], ["aoss:DescribeIndex", "aoss:ReadDocument", "aoss:WriteDocument"]);
            props.openSearchVector.createOpenSearchWorkspaceWorkflow.grantStartExecution(fileImportJobRole);
        }
        if (props.sageMakerRagModelsEndpoint) {
            fileImportJobRole.addToPolicy(new iam.PolicyStatement({
                actions: ["sagemaker:InvokeEndpoint"],
                resources: [props.sageMakerRagModelsEndpoint.ref],
            }));
        }
        if (props.config.bedrock?.enabled) {
            fileImportJobRole.addToPolicy(new iam.PolicyStatement({
                actions: [
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream",
                ],
                resources: ["arn:aws:bedrock:*"],
            }));
            if (props.config.bedrock?.roleArn) {
                fileImportJobRole.addToPolicy(new iam.PolicyStatement({
                    actions: ["sts:AssumeRole"],
                    resources: [props.config.bedrock.roleArn],
                }));
            }
        }
        this.jobQueue = jobQueue;
        this.fileImportJob = fileImportJob;
        /**
         * CDK NAG suppression
         */
        cdk_nag_1.NagSuppressions.addResourceSuppressions(fileImportJobRole, [
            {
                id: "AwsSolutions-IAM4",
                reason: "Allow user freedom of model usage in Bedrock.",
            },
            {
                id: "AwsSolutions-IAM5",
                reason: "Access to all log groups required for CloudWatch log group creation.",
            },
            {
                id: "AwsSolutions-IAM5",
                reason: "S3 write access required for upload and processing buckets.",
            },
        ]);
    }
}
exports.FileImportBatchJob = FileImportBatchJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1pbXBvcnQtYmF0Y2gtam9iLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZS1pbXBvcnQtYmF0Y2gtam9iLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQywyQ0FBdUM7QUFLdkMsK0NBQStDO0FBQy9DLDJDQUEyQztBQUMzQywyQ0FBMkM7QUFFM0MsNkRBQTZEO0FBQzdELDJDQUEyQztBQUczQyxxQ0FBMEM7QUFhMUMsTUFBYSxrQkFBbUIsU0FBUSxzQkFBUztJQUkvQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQThCO1FBQ3RFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FDbEUsSUFBSSxFQUNKLGlDQUFpQyxFQUNqQztZQUNFLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUc7WUFDckIsYUFBYSxFQUFFO2dCQUNiLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO2FBQ25FO1lBQ0QsUUFBUSxFQUFFLENBQUM7WUFDWCxRQUFRLEVBQUUsQ0FBQztZQUNYLHlCQUF5QixFQUFFLElBQUk7WUFDL0IsYUFBYSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUN2QywwQkFBMEIsRUFBRSxJQUFJO1NBQ2pDLENBQ0YsQ0FBQztRQUVGLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQ3BELG1CQUFtQixFQUFFO2dCQUNuQjtvQkFDRSxrQkFBa0I7b0JBQ2xCLEtBQUssRUFBRSxDQUFDO2lCQUNUO2FBQ0Y7WUFDRCxRQUFRLEVBQUUsQ0FBQztTQUNaLENBQUMsQ0FBQztR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cm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBTeXN0ZW1Db25maWcgfSBmcm9tIFwiLi4vLi4vc2hhcmVkL3R5cGVzXCI7XG5pbXBvcnQgeyBTaGFyZWQgfSBmcm9tIFwiLi4vLi4vc2hhcmVkXCI7XG5pbXBvcnQgeyBSYWdEeW5hbW9EQlRhYmxlcyB9IGZyb20gXCIuLi9yYWctZHluYW1vZGItdGFibGVzXCI7XG5pbXBvcnQgeyBPcGVuU2VhcmNoVmVjdG9yIH0gZnJvbSBcIi4uL29wZW5zZWFyY2gtdmVjdG9yXCI7XG5pbXBvcnQgKiBhcyBiYXRjaCBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWJhdGNoXCI7XG5pbXBvcnQgKiBhcyBlY3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lY3NcIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgYXdzX2Vjcl9hc3NldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lY3ItYXNzZXRzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHJkcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJkc1wiO1xuaW1wb3J0ICogYXMgc2FnZW1ha2VyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc2FnZW1ha2VyXCI7XG5pbXBvcnQgeyBOYWdTdXBwcmVzc2lvbnMgfSBmcm9tIFwiY2RrLW5hZ1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVJbXBvcnRCYXRjaEpvYlByb3BzIHtcbiAgcmVhZG9ubHkgY29uZmlnOiBTeXN0ZW1Db25maWc7XG4gIHJlYWRvbmx5IHNoYXJlZDogU2hhcmVkO1xuICByZWFkb25seSB1cGxvYWRCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcmVhZG9ubHkgcHJvY2Vzc2luZ0J1Y2tldDogczMuQnVja2V0O1xuICByZWFkb25seSByYWdEeW5hbW9EQlRhYmxlczogUmFnRHluYW1vREJUYWJsZXM7XG4gIHJlYWRvbmx5IGF1cm9yYURhdGFiYXNlPzogcmRzLkRhdGFiYXNlQ2x1c3RlcjtcbiAgcmVhZG9ubHkgc2FnZU1ha2VyUmFnTW9kZWxzRW5kcG9pbnQ/OiBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnQ7XG4gIHJlYWRvbmx5IG9wZW5TZWFyY2hWZWN0b3I/OiBPcGVuU2VhcmNoVmVjdG9yO1xufVxuXG5leHBvcnQgY2xhc3MgRmlsZUltcG9ydEJhdGNoSm9iIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGpvYlF1ZXVlOiBiYXRjaC5Kb2JRdWV1ZTtcbiAgcHVibGljIHJlYWRvbmx5IGZpbGVJbXBvcnRKb2I6IGJhdGNoLkVjc0pvYkRlZmluaXRpb247XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEZpbGVJbXBvcnRCYXRjaEpvYlByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGNvbXB1dGVFbnZpcm9ubWVudCA9IG5ldyBiYXRjaC5NYW5hZ2VkRWMyRWNzQ29tcHV0ZUVudmlyb25tZW50KFxuICAgICAgdGhpcyxcbiAgICAgIFwiTWFuYWdlZEVjMkVjc0NvbXB1dGVFbnZpcm9ubWVudFwiLFxuICAgICAge1xuICAgICAgICB2cGM6IHByb3BzLnNoYXJlZC52cGMsXG4gICAgICAgIGluc3RhbmNlVHlwZXM6IFtcbiAgICAgICAgICBlYzIuSW5zdGFuY2VUeXBlLm9mKGVjMi5JbnN0YW5jZUNsYXNzLk02QSwgZWMyLkluc3RhbmNlU2l6ZS5MQVJHRSksXG4gICAgICAgIF0sXG4gICAgICAgIG1heHZDcHVzOiA0LFxuICAgICAgICBtaW52Q3B1czogMCxcbiAgICAgICAgcmVwbGFjZUNvbXB1dGVFbnZpcm9ubWVudDogdHJ1ZSxcbiAgICAgICAgdXBkYXRlVGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMzApLFxuICAgICAgICB1cGRhdGVUb0xhdGVzdEltYWdlVmVyc2lvbjogdHJ1ZSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3Qgam9iUXVldWUgPSBuZXcgYmF0Y2guSm9iUXVldWUodGhpcywgXCJKb2JRdWV1ZVwiLCB7XG4gICAgICBjb21wdXRlRW52aXJvbm1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBjb21wdXRlRW52aXJvbm1lbnQsXG4gICAgICAgICAgb3JkZXI6IDEsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgcHJpb3JpdHk6IDEsXG4gICAgfSk7XG5cbiAgICBjb25zdCBmaWxlSW1wb3J0Sm9iUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIkZpbGVJbXBvcnRKb2JSb2xlXCIsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiZWNzLXRhc2tzLmFtYXpvbmF3cy5jb21cIiksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFxuICAgICAgICAgIFwic2VydmljZS1yb2xlL0FtYXpvbkVDU1Rhc2tFeGVjdXRpb25Sb2xlUG9saWN5XCJcbiAgICAgICAgKSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBmaWxlSW1wb3J0Q29udGFpbmVyID0gbmV3IGJhdGNoLkVjc0VjMkNvbnRhaW5lckRlZmluaXRpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJGaWxlSW1wb3J0Q29udGFpbmVyXCIsXG4gICAgICB7XG4gICAgICAgIGNwdTogMixcbiAgICAgICAgbWVtb3J5OiBjZGsuU2l6ZS5tZWJpYnl0ZXMoMjA0OCksXG4gICAgICAgIGltYWdlOiBlY3MuQ29udGFpbmVySW1hZ2UuZnJvbUFzc2V0KFwibGliL3NoYXJlZFwiLCB7XG4gICAgICAgICAgcGxhdGZvcm06IGF3c19lY3JfYXNzZXRzLlBsYXRmb3JtLkxJTlVYX0FNRDY0LFxuICAgICAgICAgIGZpbGU6IFwiZmlsZS1pbXBvcnQtZG9ja2VyZmlsZVwiLFxuICAgICAgICB9KSxcbiAgICAgICAgam9iUm9sZTogZmlsZUltcG9ydEpvYlJvbGUsXG4gICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgQVdTX0RFRkFVTFRfUkVHSU9OOiBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICAgIENPTkZJR19QQVJBTUVURVJfTkFNRTogcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5wYXJhbWV0ZXJOYW1lLFxuICAgICAgICAgIEFQSV9LRVlTX1NFQ1JFVFNfQVJOOiBwcm9wcy5zaGFyZWQuYXBpS2V5c1NlY3JldC5zZWNyZXRBcm4sXG4gICAgICAgICAgQVVST1JBX0RCX1NFQ1JFVF9JRDogcHJvcHMuYXVyb3JhRGF0YWJhc2U/LnNlY3JldFxuICAgICAgICAgICAgPy5zZWNyZXRBcm4gYXMgc3RyaW5nLFxuICAgICAgICAgIFBST0NFU1NJTkdfQlVDS0VUX05BTUU6IHByb3BzLnByb2Nlc3NpbmdCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgICBXT1JLU1BBQ0VTX1RBQkxFX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy53b3Jrc3BhY2VzVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgIFdPUktTUEFDRVNfQllfT0JKRUNUX1RZUEVfSU5ERVhfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNCeU9iamVjdFR5cGVJbmRleE5hbWUsXG4gICAgICAgICAgRE9DVU1FTlRTX1RBQkxFX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy5kb2N1bWVudHNUYWJsZS50YWJsZU5hbWUgPz8gXCJcIixcbiAgICAgICAgICBET0NVTUVOVFNfQllfQ09NUE9VTkRfS0VZX0lOREVYX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy5kb2N1bWVudHNCeUNvbXBvdW5kS2V5SW5kZXhOYW1lID8/IFwiXCIsXG4gICAgICAgICAgU0FHRU1BS0VSX1JBR19NT0RFTFNfRU5EUE9JTlQ6XG4gICAgICAgICAgICBwcm9wcy5zYWdlTWFrZXJSYWdNb2RlbHNFbmRwb2ludD8uYXR0ckVuZHBvaW50TmFtZSA/PyBcIlwiLFxuICAgICAgICAgIE9QRU5fU0VBUkNIX0NPTExFQ1RJT05fRU5EUE9JTlQ6XG4gICAgICAgICAgICBwcm9wcy5vcGVuU2VhcmNoVmVjdG9yPy5vcGVuU2VhcmNoQ29sbGVjdGlvbkVuZHBvaW50ID8/IFwiXCIsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IGZpbGVJbXBvcnRKb2IgPSBuZXcgYmF0Y2guRWNzSm9iRGVmaW5pdGlvbih0aGlzLCBcIkZpbGVJbXBvcnRKb2JcIiwge1xuICAgICAgY29udGFpbmVyOiBmaWxlSW1wb3J0Q29udGFpbmVyLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMzApLFxuICAgICAgcmV0cnlBdHRlbXB0czogMyxcbiAgICAgIHJldHJ5U3RyYXRlZ2llczogW1xuICAgICAgICBiYXRjaC5SZXRyeVN0cmF0ZWd5Lm9mKFxuICAgICAgICAgIGJhdGNoLkFjdGlvbi5FWElULFxuICAgICAgICAgIGJhdGNoLlJlYXNvbi5DQU5OT1RfUFVMTF9DT05UQUlORVJcbiAgICAgICAgKSxcbiAgICAgICAgYmF0Y2guUmV0cnlTdHJhdGVneS5vZihcbiAgICAgICAgICBiYXRjaC5BY3Rpb24uRVhJVCxcbiAgICAgICAgICBiYXRjaC5SZWFzb24uY3VzdG9tKHtcbiAgICAgICAgICAgIG9uRXhpdENvZGU6IFwiMTM3XCIsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBwcm9wcy51cGxvYWRCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZmlsZUltcG9ydEpvYlJvbGUpO1xuICAgIHByb3BzLnByb2Nlc3NpbmdCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZmlsZUltcG9ydEpvYlJvbGUpO1xuICAgIHByb3BzLnNoYXJlZC5jb25maWdQYXJhbWV0ZXIuZ3JhbnRSZWFkKGZpbGVJbXBvcnRKb2JSb2xlKTtcbiAgICBwcm9wcy5zaGFyZWQuYXBpS2V5c1NlY3JldC5ncmFudFJlYWQoZmlsZUltcG9ydEpvYlJvbGUpO1xuICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoXG4gICAgICBmaWxlSW1wb3J0Sm9iUm9sZVxuICAgICk7XG4gICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKFxuICAgICAgZmlsZUltcG9ydEpvYlJvbGVcbiAgICApO1xuXG4gICAgaWYgKHByb3BzLmF1cm9yYURhdGFiYXNlKSB7XG4gICAgICBwcm9wcy5hdXJvcmFEYXRhYmFzZS5zZWNyZXQ/LmdyYW50UmVhZChmaWxlSW1wb3J0Sm9iUm9sZSk7XG4gICAgICBwcm9wcy5hdXJvcmFEYXRhYmFzZS5jb25uZWN0aW9ucy5hbGxvd0RlZmF1bHRQb3J0RnJvbShjb21wdXRlRW52aXJvbm1lbnQpO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5vcGVuU2VhcmNoVmVjdG9yKSB7XG4gICAgICBmaWxlSW1wb3J0Sm9iUm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcImFvc3M6QVBJQWNjZXNzQWxsXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLm9wZW5TZWFyY2hWZWN0b3Iub3BlblNlYXJjaENvbGxlY3Rpb24uYXR0ckFybl0sXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBwcm9wcy5vcGVuU2VhcmNoVmVjdG9yLmFkZFRvQWNjZXNzUG9saWN5KFxuICAgICAgICBcImZpbGUtaW1wb3J0LWpvYlwiLFxuICAgICAgICBbZmlsZUltcG9ydEpvYlJvbGUucm9sZUFybl0sXG4gICAgICAgIFtcImFvc3M6RGVzY3JpYmVJbmRleFwiLCBcImFvc3M6UmVhZERvY3VtZW50XCIsIFwiYW9zczpXcml0ZURvY3VtZW50XCJdXG4gICAgICApO1xuXG4gICAgICBwcm9wcy5vcGVuU2VhcmNoVmVjdG9yLmNyZWF0ZU9wZW5TZWFyY2hXb3Jrc3BhY2VXb3JrZmxvdy5ncmFudFN0YXJ0RXhlY3V0aW9uKFxuICAgICAgICBmaWxlSW1wb3J0Sm9iUm9sZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMuc2FnZU1ha2VyUmFnTW9kZWxzRW5kcG9pbnQpIHtcbiAgICAgIGZpbGVJbXBvcnRKb2JSb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogW1wic2FnZW1ha2VyOkludm9rZUVuZHBvaW50XCJdLFxuICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLnNhZ2VNYWtlclJhZ01vZGVsc0VuZHBvaW50LnJlZl0sXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5jb25maWcuYmVkcm9jaz8uZW5hYmxlZCkge1xuICAgICAgZmlsZUltcG9ydEpvYlJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICBcImJlZHJvY2s6SW52b2tlTW9kZWxcIixcbiAgICAgICAgICAgIFwiYmVkcm9jazpJbnZva2VNb2RlbFdpdGhSZXNwb25zZVN0cmVhbVwiLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbXCJhcm46YXdzOmJlZHJvY2s6KlwiXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGlmIChwcm9wcy5jb25maWcuYmVkcm9jaz8ucm9sZUFybikge1xuICAgICAgICBmaWxlSW1wb3J0Sm9iUm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbXCJzdHM6QXNzdW1lUm9sZVwiXSxcbiAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLmNvbmZpZy5iZWRyb2NrLnJvbGVBcm5dLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5qb2JRdWV1ZSA9IGpvYlF1ZXVlO1xuICAgIHRoaXMuZmlsZUltcG9ydEpvYiA9IGZpbGVJbXBvcnRKb2I7XG5cbiAgICAvKipcbiAgICAgKiBDREsgTkFHIHN1cHByZXNzaW9uXG4gICAgICovXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFJlc291cmNlU3VwcHJlc3Npb25zKGZpbGVJbXBvcnRKb2JSb2xlLCBbXG4gICAgICB7XG4gICAgICAgIGlkOiBcIkF3c1NvbHV0aW9ucy1JQU00XCIsXG4gICAgICAgIHJlYXNvbjogXCJBbGxvdyB1c2VyIGZyZWVkb20gb2YgbW9kZWwgdXNhZ2UgaW4gQmVkcm9jay5cIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGlkOiBcIkF3c1NvbHV0aW9ucy1JQU01XCIsXG4gICAgICAgIHJlYXNvbjpcbiAgICAgICAgICBcIkFjY2VzcyB0byBhbGwgbG9nIGdyb3VwcyByZXF1aXJlZCBmb3IgQ2xvdWRXYXRjaCBsb2cgZ3JvdXAgY3JlYXRpb24uXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBpZDogXCJBd3NTb2x1dGlvbnMtSUFNNVwiLFxuICAgICAgICByZWFzb246IFwiUzMgd3JpdGUgYWNjZXNzIHJlcXVpcmVkIGZvciB1cGxvYWQgYW5kIHByb2Nlc3NpbmcgYnVja2V0cy5cIixcbiAgICAgIH0sXG4gICAgXSk7XG4gIH1cbn1cbiJdfQ==