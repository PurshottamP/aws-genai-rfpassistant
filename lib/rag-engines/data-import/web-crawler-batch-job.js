"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebCrawlerBatchJob = void 0;
const cdk = require("aws-cdk-lib");
const constructs_1 = require("constructs");
const batch = require("aws-cdk-lib/aws-batch");
const ecs = require("aws-cdk-lib/aws-ecs");
const ec2 = require("aws-cdk-lib/aws-ec2");
const aws_ecr_assets = require("aws-cdk-lib/aws-ecr-assets");
const iam = require("aws-cdk-lib/aws-iam");
const cdk_nag_1 = require("cdk-nag");
class WebCrawlerBatchJob extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const computeEnvironment = new batch.ManagedEc2EcsComputeEnvironment(this, "WebCrawlerManagedEc2EcsComputeEnvironment", {
            vpc: props.shared.vpc,
            instanceTypes: [
                ec2.InstanceType.of(ec2.InstanceClass.M6A, ec2.InstanceSize.LARGE),
            ],
            maxvCpus: 4,
            minvCpus: 0,
            replaceComputeEnvironment: true,
            updateTimeout: cdk.Duration.minutes(30),
            updateToLatestImageVersion: true,
        });
        const jobQueue = new batch.JobQueue(this, "WebCrawlerJobQueue", {
            computeEnvironments: [
                {
                    computeEnvironment,
                    order: 1,
                },
            ],
            priority: 1,
        });
        const webCrawlerJobRole = new iam.Role(this, "WebCrawlerJobRole", {
            assumedBy: new iam.ServicePrincipal("ecs-tasks.amazonaws.com"),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AmazonECSTaskExecutionRolePolicy"),
            ],
        });
        const webCrawlerContainer = new batch.EcsEc2ContainerDefinition(this, "WebCrawlerContainer", {
            cpu: 2,
            memory: cdk.Size.mebibytes(2048),
            image: ecs.ContainerImage.fromAsset("lib/shared", {
                platform: aws_ecr_assets.Platform.LINUX_AMD64,
                file: "web-crawler-dockerfile",
            }),
            jobRole: webCrawlerJobRole,
            environment: {
                AWS_DEFAULT_REGION: cdk.Stack.of(this).region,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                API_KEYS_SECRETS_ARN: props.shared.apiKeysSecret.secretArn,
                AURORA_DB_SECRET_ID: props.auroraDatabase?.secret
                    ?.secretArn,
                PROCESSING_BUCKET_NAME: props.processingBucket.bucketName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables.documentsByCompoundKeyIndexName ?? "",
                SAGEMAKER_RAG_MODELS_ENDPOINT: props.sageMakerRagModelsEndpoint?.attrEndpointName ?? "",
                OPEN_SEARCH_COLLECTION_ENDPOINT: props.openSearchVector?.openSearchCollectionEndpoint ?? "",
            },
        });
        const webCrawlerJob = new batch.EcsJobDefinition(this, "WebCrawlerJob", {
            container: webCrawlerContainer,
            retryAttempts: 3,
            retryStrategies: [
                batch.RetryStrategy.of(batch.Action.EXIT, batch.Reason.CANNOT_PULL_CONTAINER),
                batch.RetryStrategy.of(batch.Action.EXIT, batch.Reason.custom({
                    onExitCode: "137",
                })),
            ],
        });
        props.uploadBucket.grantReadWrite(webCrawlerJobRole);
        props.processingBucket.grantReadWrite(webCrawlerJobRole);
        props.shared.configParameter.grantRead(webCrawlerJobRole);
        props.shared.apiKeysSecret.grantRead(webCrawlerJobRole);
        props.ragDynamoDBTables.workspacesTable.grantReadWriteData(webCrawlerJobRole);
        props.ragDynamoDBTables.documentsTable.grantReadWriteData(webCrawlerJobRole);
        if (props.auroraDatabase) {
            props.auroraDatabase.secret?.grantRead(webCrawlerJobRole);
            props.auroraDatabase.connections.allowDefaultPortFrom(computeEnvironment);
        }
        if (props.openSearchVector) {
            webCrawlerJobRole.addToPolicy(new iam.PolicyStatement({
                actions: ["aoss:APIAccessAll"],
                resources: [props.openSearchVector.openSearchCollection.attrArn],
            }));
            props.openSearchVector.addToAccessPolicy("web-crawler-job", [webCrawlerJobRole.roleArn], ["aoss:DescribeIndex", "aoss:ReadDocument", "aoss:WriteDocument"]);
            props.openSearchVector.createOpenSearchWorkspaceWorkflow.grantStartExecution(webCrawlerJobRole);
        }
        if (props.sageMakerRagModelsEndpoint) {
            webCrawlerJobRole.addToPolicy(new iam.PolicyStatement({
                actions: ["sagemaker:InvokeEndpoint"],
                resources: [props.sageMakerRagModelsEndpoint.ref],
            }));
        }
        if (props.config.bedrock?.enabled) {
            webCrawlerJobRole.addToPolicy(new iam.PolicyStatement({
                actions: [
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream",
                ],
                resources: ["arn:aws:bedrock:*"],
            }));
            if (props.config.bedrock?.roleArn) {
                webCrawlerJobRole.addToPolicy(new iam.PolicyStatement({
                    actions: ["sts:AssumeRole"],
                    resources: [props.config.bedrock.roleArn],
                }));
            }
        }
        this.jobQueue = jobQueue;
        this.fileImportJob = webCrawlerJob;
        /**
         * CDK NAG suppression
         */
        cdk_nag_1.NagSuppressions.addResourceSuppressions(webCrawlerJobRole, [
            {
                id: "AwsSolutions-IAM4",
                reason: "Allow user freedom of model usage in Bedrock.",
            },
            {
                id: "AwsSolutions-IAM5",
                reason: "Access to all log groups required for CloudWatch log group creation.",
            },
            {
                id: "AwsSolutions-IAM5",
                reason: "S3 write access required for upload and processing buckets.",
            },
        ]);
    }
}
exports.WebCrawlerBatchJob = WebCrawlerBatchJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViLWNyYXdsZXItYmF0Y2gtam9iLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2ViLWNyYXdsZXItYmF0Y2gtam9iLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQywyQ0FBdUM7QUFLdkMsK0NBQStDO0FBQy9DLDJDQUEyQztBQUMzQywyQ0FBMkM7QUFFM0MsNkRBQTZEO0FBQzdELDJDQUEyQztBQUczQyxxQ0FBMEM7QUFhMUMsTUFBYSxrQkFBbUIsU0FBUSxzQkFBUztJQUkvQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQThCO1FBQ3RFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FDbEUsSUFBSSxFQUNKLDJDQUEyQyxFQUMzQztZQUNFLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUc7WUFDckIsYUFBYSxFQUFFO2dCQUNiLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO2FBQ25FO1lBQ0QsUUFBUSxFQUFFLENBQUM7WUFDWCxRQUFRLEVBQUUsQ0FBQztZQUNYLHlCQUF5QixFQUFFLElBQUk7WUFDL0IsYUFBYSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUN2QywwQkFBMEIsRUFBRSxJQUFJO1NBQ2pDLENBQ0YsQ0FBQztRQUVGLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUU7WUFDOUQsbUJBQW1CLEVBQUU7Z0JBQ25CO29CQUNFLGtCQUFrQjtvQkFDbEIsS0FBSyxFQUFFLENBQUM7aUJBQ1Q7YUFDRjtZQUNELFFBQVEsRUFBRSxDQUFDO1NBQ1osQ0FBQyxDQUFD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YUFDbEQsQ0FBQyxDQUNILENBQUM7U0FDSDtRQUVELElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFO1lBQ2pDLGlCQUFpQixDQUFDLFdBQVcsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUN0QixPQUFPLEVBQUU7b0JBQ1AscUJBQXFCO29CQUNyQix1Q0FBdUM7aUJBQ3hDO2dCQUNELFNBQVMsRUFBRSxDQUFDLG1CQUFtQixDQUFDO2FBQ2pDLENBQUMsQ0FDSCxDQUFDO1lBRUYsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUU7Z0JBQ2pDLGlCQUFpQixDQUFDLFdBQVcsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO29CQUN0QixPQUFPLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDM0IsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO2lCQUMxQyxDQUFDLENBQ0gsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztRQUVuQzs7V0FFRztRQUNILHlCQUFlLENBQUMsdUJBQXVCLENBQUMsaUJBQWlCLEVBQUU7WUFDekQ7Z0JBQ0UsRUFBRSxFQUFFLG1CQUFtQjtnQkFDdkIsTUFBTSxFQUFFLCtDQUErQzthQUN4RDtZQUNEO2dCQUNFLEVBQUUsRUFBRSxtQkFBbUI7Z0JBQ3ZCLE1BQU0sRUFDSixzRUFBc0U7YUFDekU7WUFDRDtnQkFDRSxFQUFFLEVBQUUsbUJBQW1CO2dCQUN2QixNQUFNLEVBQUUsNkRBQTZEO2FBQ3RFO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBcExELGdEQW9MQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBTeXN0ZW1Db25maWcgfSBmcm9tIFwiLi4vLi4vc2hhcmVkL3R5cGVzXCI7XG5pbXBvcnQgeyBTaGFyZWQgfSBmcm9tIFwiLi4vLi4vc2hhcmVkXCI7XG5pbXBvcnQgeyBSYWdEeW5hbW9EQlRhYmxlcyB9IGZyb20gXCIuLi9yYWctZHluYW1vZGItdGFibGVzXCI7XG5pbXBvcnQgeyBPcGVuU2VhcmNoVmVjdG9yIH0gZnJvbSBcIi4uL29wZW5zZWFyY2gtdmVjdG9yXCI7XG5pbXBvcnQgKiBhcyBiYXRjaCBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWJhdGNoXCI7XG5pbXBvcnQgKiBhcyBlY3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lY3NcIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgYXdzX2Vjcl9hc3NldHMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lY3ItYXNzZXRzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIHJkcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXJkc1wiO1xuaW1wb3J0ICogYXMgc2FnZW1ha2VyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc2FnZW1ha2VyXCI7XG5pbXBvcnQgeyBOYWdTdXBwcmVzc2lvbnMgfSBmcm9tIFwiY2RrLW5hZ1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdlYkNyYXdsZXJCYXRjaEpvYlByb3BzIHtcbiAgcmVhZG9ubHkgY29uZmlnOiBTeXN0ZW1Db25maWc7XG4gIHJlYWRvbmx5IHNoYXJlZDogU2hhcmVkO1xuICByZWFkb25seSB1cGxvYWRCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcmVhZG9ubHkgcHJvY2Vzc2luZ0J1Y2tldDogczMuQnVja2V0O1xuICByZWFkb25seSByYWdEeW5hbW9EQlRhYmxlczogUmFnRHluYW1vREJUYWJsZXM7XG4gIHJlYWRvbmx5IGF1cm9yYURhdGFiYXNlPzogcmRzLkRhdGFiYXNlQ2x1c3RlcjtcbiAgcmVhZG9ubHkgc2FnZU1ha2VyUmFnTW9kZWxzRW5kcG9pbnQ/OiBzYWdlbWFrZXIuQ2ZuRW5kcG9pbnQ7XG4gIHJlYWRvbmx5IG9wZW5TZWFyY2hWZWN0b3I/OiBPcGVuU2VhcmNoVmVjdG9yO1xufVxuXG5leHBvcnQgY2xhc3MgV2ViQ3Jhd2xlckJhdGNoSm9iIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGpvYlF1ZXVlOiBiYXRjaC5Kb2JRdWV1ZTtcbiAgcHVibGljIHJlYWRvbmx5IGZpbGVJbXBvcnRKb2I6IGJhdGNoLkVjc0pvYkRlZmluaXRpb247XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFdlYkNyYXdsZXJCYXRjaEpvYlByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IGNvbXB1dGVFbnZpcm9ubWVudCA9IG5ldyBiYXRjaC5NYW5hZ2VkRWMyRWNzQ29tcHV0ZUVudmlyb25tZW50KFxuICAgICAgdGhpcyxcbiAgICAgIFwiV2ViQ3Jhd2xlck1hbmFnZWRFYzJFY3NDb21wdXRlRW52aXJvbm1lbnRcIixcbiAgICAgIHtcbiAgICAgICAgdnBjOiBwcm9wcy5zaGFyZWQudnBjLFxuICAgICAgICBpbnN0YW5jZVR5cGVzOiBbXG4gICAgICAgICAgZWMyLkluc3RhbmNlVHlwZS5vZihlYzIuSW5zdGFuY2VDbGFzcy5NNkEsIGVjMi5JbnN0YW5jZVNpemUuTEFSR0UpLFxuICAgICAgICBdLFxuICAgICAgICBtYXh2Q3B1czogNCxcbiAgICAgICAgbWludkNwdXM6IDAsXG4gICAgICAgIHJlcGxhY2VDb21wdXRlRW52aXJvbm1lbnQ6IHRydWUsXG4gICAgICAgIHVwZGF0ZVRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDMwKSxcbiAgICAgICAgdXBkYXRlVG9MYXRlc3RJbWFnZVZlcnNpb246IHRydWUsXG4gICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IGpvYlF1ZXVlID0gbmV3IGJhdGNoLkpvYlF1ZXVlKHRoaXMsIFwiV2ViQ3Jhd2xlckpvYlF1ZXVlXCIsIHtcbiAgICAgIGNvbXB1dGVFbnZpcm9ubWVudHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIGNvbXB1dGVFbnZpcm9ubWVudCxcbiAgICAgICAgICBvcmRlcjogMSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBwcmlvcml0eTogMSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHdlYkNyYXdsZXJKb2JSb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIFwiV2ViQ3Jhd2xlckpvYlJvbGVcIiwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJlY3MtdGFza3MuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXG4gICAgICAgICAgXCJzZXJ2aWNlLXJvbGUvQW1hem9uRUNTVGFza0V4ZWN1dGlvblJvbGVQb2xpY3lcIlxuICAgICAgICApLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHdlYkNyYXdsZXJDb250YWluZXIgPSBuZXcgYmF0Y2guRWNzRWMyQ29udGFpbmVyRGVmaW5pdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBcIldlYkNyYXdsZXJDb250YWluZXJcIixcbiAgICAgIHtcbiAgICAgICAgY3B1OiAyLFxuICAgICAgICBtZW1vcnk6IGNkay5TaXplLm1lYmlieXRlcygyMDQ4KSxcbiAgICAgICAgaW1hZ2U6IGVjcy5Db250YWluZXJJbWFnZS5mcm9tQXNzZXQoXCJsaWIvc2hhcmVkXCIsIHtcbiAgICAgICAgICBwbGF0Zm9ybTogYXdzX2Vjcl9hc3NldHMuUGxhdGZvcm0uTElOVVhfQU1ENjQsXG4gICAgICAgICAgZmlsZTogXCJ3ZWItY3Jhd2xlci1kb2NrZXJmaWxlXCIsXG4gICAgICAgIH0pLFxuICAgICAgICBqb2JSb2xlOiB3ZWJDcmF3bGVySm9iUm9sZSxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBBV1NfREVGQVVMVF9SRUdJT046IGNkay5TdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgICAgICAgQ09ORklHX1BBUkFNRVRFUl9OQU1FOiBwcm9wcy5zaGFyZWQuY29uZmlnUGFyYW1ldGVyLnBhcmFtZXRlck5hbWUsXG4gICAgICAgICAgQVBJX0tFWVNfU0VDUkVUU19BUk46IHByb3BzLnNoYXJlZC5hcGlLZXlzU2VjcmV0LnNlY3JldEFybixcbiAgICAgICAgICBBVVJPUkFfREJfU0VDUkVUX0lEOiBwcm9wcy5hdXJvcmFEYXRhYmFzZT8uc2VjcmV0XG4gICAgICAgICAgICA/LnNlY3JldEFybiBhcyBzdHJpbmcsXG4gICAgICAgICAgUFJPQ0VTU0lOR19CVUNLRVRfTkFNRTogcHJvcHMucHJvY2Vzc2luZ0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICAgIFdPUktTUEFDRVNfVEFCTEVfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgV09SS1NQQUNFU19CWV9PQkpFQ1RfVFlQRV9JTkRFWF9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc0J5T2JqZWN0VHlwZUluZGV4TmFtZSxcbiAgICAgICAgICBET0NVTUVOVFNfVEFCTEVfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c1RhYmxlLnRhYmxlTmFtZSA/PyBcIlwiLFxuICAgICAgICAgIERPQ1VNRU5UU19CWV9DT01QT1VORF9LRVlfSU5ERVhfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c0J5Q29tcG91bmRLZXlJbmRleE5hbWUgPz8gXCJcIixcbiAgICAgICAgICBTQUdFTUFLRVJfUkFHX01PREVMU19FTkRQT0lOVDpcbiAgICAgICAgICAgIHByb3BzLnNhZ2VNYWtlclJhZ01vZGVsc0VuZHBvaW50Py5hdHRyRW5kcG9pbnROYW1lID8/IFwiXCIsXG4gICAgICAgICAgT1BFTl9TRUFSQ0hfQ09MTEVDVElPTl9FTkRQT0lOVDpcbiAgICAgICAgICAgIHByb3BzLm9wZW5TZWFyY2hWZWN0b3I/Lm9wZW5TZWFyY2hDb2xsZWN0aW9uRW5kcG9pbnQgPz8gXCJcIixcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3Qgd2ViQ3Jhd2xlckpvYiA9IG5ldyBiYXRjaC5FY3NKb2JEZWZpbml0aW9uKHRoaXMsIFwiV2ViQ3Jhd2xlckpvYlwiLCB7XG4gICAgICBjb250YWluZXI6IHdlYkNyYXdsZXJDb250YWluZXIsXG4gICAgICByZXRyeUF0dGVtcHRzOiAzLFxuICAgICAgcmV0cnlTdHJhdGVnaWVzOiBbXG4gICAgICAgIGJhdGNoLlJldHJ5U3RyYXRlZ3kub2YoXG4gICAgICAgICAgYmF0Y2guQWN0aW9uLkVYSVQsXG4gICAgICAgICAgYmF0Y2guUmVhc29uLkNBTk5PVF9QVUxMX0NPTlRBSU5FUlxuICAgICAgICApLFxuICAgICAgICBiYXRjaC5SZXRyeVN0cmF0ZWd5Lm9mKFxuICAgICAgICAgIGJhdGNoLkFjdGlvbi5FWElULFxuICAgICAgICAgIGJhdGNoLlJlYXNvbi5jdXN0b20oe1xuICAgICAgICAgICAgb25FeGl0Q29kZTogXCIxMzdcIixcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIHByb3BzLnVwbG9hZEJ1Y2tldC5ncmFudFJlYWRXcml0ZSh3ZWJDcmF3bGVySm9iUm9sZSk7XG4gICAgcHJvcHMucHJvY2Vzc2luZ0J1Y2tldC5ncmFudFJlYWRXcml0ZSh3ZWJDcmF3bGVySm9iUm9sZSk7XG4gICAgcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5ncmFudFJlYWQod2ViQ3Jhd2xlckpvYlJvbGUpO1xuICAgIHByb3BzLnNoYXJlZC5hcGlLZXlzU2VjcmV0LmdyYW50UmVhZCh3ZWJDcmF3bGVySm9iUm9sZSk7XG4gICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShcbiAgICAgIHdlYkNyYXdsZXJKb2JSb2xlXG4gICAgKTtcbiAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy5kb2N1bWVudHNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoXG4gICAgICB3ZWJDcmF3bGVySm9iUm9sZVxuICAgICk7XG5cbiAgICBpZiAocHJvcHMuYXVyb3JhRGF0YWJhc2UpIHtcbiAgICAgIHByb3BzLmF1cm9yYURhdGFiYXNlLnNlY3JldD8uZ3JhbnRSZWFkKHdlYkNyYXdsZXJKb2JSb2xlKTtcbiAgICAgIHByb3BzLmF1cm9yYURhdGFiYXNlLmNvbm5lY3Rpb25zLmFsbG93RGVmYXVsdFBvcnRGcm9tKGNvbXB1dGVFbnZpcm9ubWVudCk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLm9wZW5TZWFyY2hWZWN0b3IpIHtcbiAgICAgIHdlYkNyYXdsZXJKb2JSb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogW1wiYW9zczpBUElBY2Nlc3NBbGxcIl0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMub3BlblNlYXJjaFZlY3Rvci5vcGVuU2VhcmNoQ29sbGVjdGlvbi5hdHRyQXJuXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIHByb3BzLm9wZW5TZWFyY2hWZWN0b3IuYWRkVG9BY2Nlc3NQb2xpY3koXG4gICAgICAgIFwid2ViLWNyYXdsZXItam9iXCIsXG4gICAgICAgIFt3ZWJDcmF3bGVySm9iUm9sZS5yb2xlQXJuXSxcbiAgICAgICAgW1wiYW9zczpEZXNjcmliZUluZGV4XCIsIFwiYW9zczpSZWFkRG9jdW1lbnRcIiwgXCJhb3NzOldyaXRlRG9jdW1lbnRcIl1cbiAgICAgICk7XG5cbiAgICAgIHByb3BzLm9wZW5TZWFyY2hWZWN0b3IuY3JlYXRlT3BlblNlYXJjaFdvcmtzcGFjZVdvcmtmbG93LmdyYW50U3RhcnRFeGVjdXRpb24oXG4gICAgICAgIHdlYkNyYXdsZXJKb2JSb2xlXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5zYWdlTWFrZXJSYWdNb2RlbHNFbmRwb2ludCkge1xuICAgICAgd2ViQ3Jhd2xlckpvYlJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXCJzYWdlbWFrZXI6SW52b2tlRW5kcG9pbnRcIl0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMuc2FnZU1ha2VyUmFnTW9kZWxzRW5kcG9pbnQucmVmXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLmNvbmZpZy5iZWRyb2NrPy5lbmFibGVkKSB7XG4gICAgICB3ZWJDcmF3bGVySm9iUm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgIFwiYmVkcm9jazpJbnZva2VNb2RlbFwiLFxuICAgICAgICAgICAgXCJiZWRyb2NrOkludm9rZU1vZGVsV2l0aFJlc3BvbnNlU3RyZWFtXCIsXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtcImFybjphd3M6YmVkcm9jazoqXCJdLFxuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgaWYgKHByb3BzLmNvbmZpZy5iZWRyb2NrPy5yb2xlQXJuKSB7XG4gICAgICAgIHdlYkNyYXdsZXJKb2JSb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcInN0czpBc3N1bWVSb2xlXCJdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMuY29uZmlnLmJlZHJvY2sucm9sZUFybl0sXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmpvYlF1ZXVlID0gam9iUXVldWU7XG4gICAgdGhpcy5maWxlSW1wb3J0Sm9iID0gd2ViQ3Jhd2xlckpvYjtcblxuICAgIC8qKlxuICAgICAqIENESyBOQUcgc3VwcHJlc3Npb25cbiAgICAgKi9cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMod2ViQ3Jhd2xlckpvYlJvbGUsIFtcbiAgICAgIHtcbiAgICAgICAgaWQ6IFwiQXdzU29sdXRpb25zLUlBTTRcIixcbiAgICAgICAgcmVhc29uOiBcIkFsbG93IHVzZXIgZnJlZWRvbSBvZiBtb2RlbCB1c2FnZSBpbiBCZWRyb2NrLlwiLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgaWQ6IFwiQXdzU29sdXRpb25zLUlBTTVcIixcbiAgICAgICAgcmVhc29uOlxuICAgICAgICAgIFwiQWNjZXNzIHRvIGFsbCBsb2cgZ3JvdXBzIHJlcXVpcmVkIGZvciBDbG91ZFdhdGNoIGxvZyBncm91cCBjcmVhdGlvbi5cIixcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGlkOiBcIkF3c1NvbHV0aW9ucy1JQU01XCIsXG4gICAgICAgIHJlYXNvbjogXCJTMyB3cml0ZSBhY2Nlc3MgcmVxdWlyZWQgZm9yIHVwbG9hZCBhbmQgcHJvY2Vzc2luZyBidWNrZXRzLlwiLFxuICAgICAgfSxcbiAgICBdKTtcbiAgfVxufVxuIl19