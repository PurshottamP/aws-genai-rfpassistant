"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RssSubscription = void 0;
const constructs_1 = require("constructs");
const path = require("path");
const cdk = require("aws-cdk-lib");
const logs = require("aws-cdk-lib/aws-logs");
const lambda = require("aws-cdk-lib/aws-lambda");
const events = require("aws-cdk-lib/aws-events");
const targets = require("aws-cdk-lib/aws-events-targets");
class RssSubscription extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const rssIngestorFunction = new lambda.Function(this, "RssIngestor", {
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/rss-ingestor")),
            description: "Retrieves the latest data from the RSS Feed and adds any newly found posts to be queued for Website Crawling",
            architecture: props.shared.lambdaArchitecture,
            runtime: props.shared.pythonRuntime,
            tracing: lambda.Tracing.ACTIVE,
            memorySize: 1024,
            handler: "index.lambda_handler",
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            timeout: cdk.Duration.minutes(15),
            logRetention: logs.RetentionDays.ONE_WEEK,
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables.documentsByCompoundKeyIndexName ?? "",
                DOCUMENTS_BY_STATUS_INDEX: props.ragDynamoDBTables.documentsByStatusIndexName ?? "",
            },
        });
        props.shared.configParameter.grantRead(rssIngestorFunction);
        props.ragDynamoDBTables.documentsTable.grantReadWriteData(rssIngestorFunction);
        props.ragDynamoDBTables.workspacesTable.grantReadData(rssIngestorFunction);
        const triggerRssIngestorsFunction = new lambda.Function(this, "triggerRssIngestorsFunction", {
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/trigger-rss-ingestors")),
            description: "Invokes RSS Feed Ingestors for each Subscribed RSS Feed",
            architecture: props.shared.lambdaArchitecture,
            runtime: props.shared.pythonRuntime,
            tracing: lambda.Tracing.ACTIVE,
            memorySize: 1024,
            handler: "index.lambda_handler",
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            timeout: cdk.Duration.seconds(15),
            logRetention: logs.RetentionDays.ONE_WEEK,
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables.documentsByCompoundKeyIndexName ?? "",
                DOCUMENTS_BY_STATUS_INDEX: props.ragDynamoDBTables.documentsByStatusIndexName ?? "",
                PROCESSING_BUCKET_NAME: props.processingBucket.bucketName,
                RSS_FEED_INGESTOR_FUNCTION: rssIngestorFunction.functionName,
            },
        });
        rssIngestorFunction.grantInvoke(triggerRssIngestorsFunction);
        props.shared.configParameter.grantRead(triggerRssIngestorsFunction);
        props.ragDynamoDBTables.documentsTable.grantReadData(triggerRssIngestorsFunction);
        new events.Rule(this, "triggerRssIngestorsFunctionSchedule", {
            schedule: events.Schedule.rate(cdk.Duration.minutes(15)),
            targets: [new targets.LambdaFunction(triggerRssIngestorsFunction)],
        });
        const crawlQueuedRssPostsFunction = new lambda.Function(this, "crawlQueuedRssPostsFunction", {
            vpc: props.shared.vpc,
            description: "Functions polls the RSS items for pending urls and invokes Website crawler inference. Max of 10 URLs per invoke.",
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/batch-crawl-rss-posts")),
            architecture: props.shared.lambdaArchitecture,
            runtime: props.shared.pythonRuntime,
            tracing: lambda.Tracing.ACTIVE,
            memorySize: 1024,
            handler: "index.lambda_handler",
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            timeout: cdk.Duration.minutes(5),
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                WORKSPACES_TABLE_NAME: props.ragDynamoDBTables.workspacesTable.tableName,
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragDynamoDBTables.workspacesByObjectTypeIndexName,
                DOCUMENTS_TABLE_NAME: props.ragDynamoDBTables.documentsTable.tableName ?? "",
                DOCUMENTS_BY_COMPOUND_KEY_INDEX_NAME: props.ragDynamoDBTables.documentsByCompoundKeyIndexName ?? "",
                DOCUMENTS_BY_STATUS_INDEX: props.ragDynamoDBTables.documentsByStatusIndexName ?? "",
                WEBSITE_CRAWLING_WORKFLOW_ARN: props.websiteCrawlerStateMachine.stateMachineArn,
                PROCESSING_BUCKET_NAME: props.processingBucket.bucketName,
            },
        });
        props.processingBucket.grantReadWrite(crawlQueuedRssPostsFunction);
        props.websiteCrawlerStateMachine.grantStartExecution(crawlQueuedRssPostsFunction);
        new events.Rule(this, "CrawlQueuedRssPostsScheduleRule", {
            schedule: events.Schedule.rate(cdk.Duration.minutes(10)),
            targets: [new targets.LambdaFunction(crawlQueuedRssPostsFunction)],
        });
        props.shared.configParameter.grantRead(crawlQueuedRssPostsFunction);
        props.ragDynamoDBTables.documentsTable.grantReadWriteData(crawlQueuedRssPostsFunction);
        props.ragDynamoDBTables.workspacesTable.grantReadWriteData(crawlQueuedRssPostsFunction);
    }
}
exports.RssSubscription = RssSubscription;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnNzLXN1YnNjcmlwdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJzcy1zdWJzY3JpcHRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQXVDO0FBSXZDLDZCQUE2QjtBQUM3QixtQ0FBbUM7QUFDbkMsNkNBQTZDO0FBQzdDLGlEQUFpRDtBQUNqRCxpREFBaUQ7QUFDakQsMERBQTBEO0FBWTFELE1BQWEsZUFBZ0IsU0FBUSxzQkFBUztJQUU1QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWdDO1FBQ3hFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUNuRSxJQUFJLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDBCQUEwQixDQUFDLENBQ2pEO1lBQ0QsV0FBVyxFQUNULDhHQUE4RztZQUNoSCxZQUFZLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0I7WUFDN0MsT0FBTyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsYUFBYTtZQUNuQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQzlCLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLE9BQU8sRUFBRSxzQkFBc0I7WUFDL0IsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDaEUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRO1lBRXpDLFdBQVcsRUFBRTtnQkFDWCxHQUFHLEtBQUssQ0FBQyxNQUFN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LENBQzVCLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUEvSUQsMENBK0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IFN5c3RlbUNvbmZpZyB9IGZyb20gXCIuLi8uLi9zaGFyZWQvdHlwZXNcIjtcbmltcG9ydCB7IFNoYXJlZCB9IGZyb20gXCIuLi8uLi9zaGFyZWRcIjtcbmltcG9ydCB7IFJhZ0R5bmFtb0RCVGFibGVzIH0gZnJvbSBcIi4uL3JhZy1keW5hbW9kYi10YWJsZXNcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGFcIjtcbmltcG9ydCAqIGFzIGV2ZW50cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWV2ZW50c1wiO1xuaW1wb3J0ICogYXMgdGFyZ2V0cyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyBzZm4gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zdGVwZnVuY3Rpb25zXCI7XG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnNzU3Vic2NyaXB0aW9uUHJvcGVydGllcyB7XG4gIHJlYWRvbmx5IGNvbmZpZzogU3lzdGVtQ29uZmlnO1xuICByZWFkb25seSBzaGFyZWQ6IFNoYXJlZDtcbiAgcmVhZG9ubHkgcHJvY2Vzc2luZ0J1Y2tldDogczMuQnVja2V0O1xuICByZWFkb25seSByYWdEeW5hbW9EQlRhYmxlczogUmFnRHluYW1vREJUYWJsZXM7XG4gIHJlYWRvbmx5IHdlYnNpdGVDcmF3bGVyU3RhdGVNYWNoaW5lOiBzZm4uU3RhdGVNYWNoaW5lO1xufVxuXG5leHBvcnQgY2xhc3MgUnNzU3Vic2NyaXB0aW9uIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHJzc0luZ2VzdG9yRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbjtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFJzc1N1YnNjcmlwdGlvblByb3BlcnRpZXMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgcnNzSW5nZXN0b3JGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJSc3NJbmdlc3RvclwiLCB7XG4gICAgICBjb2RlOiBwcm9wcy5zaGFyZWQuc2hhcmVkQ29kZS5idW5kbGVXaXRoTGFtYmRhQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi9mdW5jdGlvbnMvcnNzLWluZ2VzdG9yXCIpXG4gICAgICApLFxuICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgIFwiUmV0cmlldmVzIHRoZSBsYXRlc3QgZGF0YSBmcm9tIHRoZSBSU1MgRmVlZCBhbmQgYWRkcyBhbnkgbmV3bHkgZm91bmQgcG9zdHMgdG8gYmUgcXVldWVkIGZvciBXZWJzaXRlIENyYXdsaW5nXCIsXG4gICAgICBhcmNoaXRlY3R1cmU6IHByb3BzLnNoYXJlZC5sYW1iZGFBcmNoaXRlY3R1cmUsXG4gICAgICBydW50aW1lOiBwcm9wcy5zaGFyZWQucHl0aG9uUnVudGltZSxcbiAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmxhbWJkYV9oYW5kbGVyXCIsXG4gICAgICBsYXllcnM6IFtwcm9wcy5zaGFyZWQucG93ZXJUb29sc0xheWVyLCBwcm9wcy5zaGFyZWQuY29tbW9uTGF5ZXJdLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbG9nUmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXMuT05FX1dFRUssXG5cbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIC4uLnByb3BzLnNoYXJlZC5kZWZhdWx0RW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgICAgIENPTkZJR19QQVJBTUVURVJfTkFNRTogcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5wYXJhbWV0ZXJOYW1lLFxuICAgICAgICBXT1JLU1BBQ0VTX1RBQkxFX05BTUU6XG4gICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgV09SS1NQQUNFU19CWV9PQkpFQ1RfVFlQRV9JTkRFWF9OQU1FOlxuICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNCeU9iamVjdFR5cGVJbmRleE5hbWUsXG4gICAgICAgIERPQ1VNRU5UU19UQUJMRV9OQU1FOlxuICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c1RhYmxlLnRhYmxlTmFtZSA/PyBcIlwiLFxuICAgICAgICBET0NVTUVOVFNfQllfQ09NUE9VTkRfS0VZX0lOREVYX05BTUU6XG4gICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzQnlDb21wb3VuZEtleUluZGV4TmFtZSA/PyBcIlwiLFxuICAgICAgICBET0NVTUVOVFNfQllfU1RBVFVTX0lOREVYOlxuICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c0J5U3RhdHVzSW5kZXhOYW1lID8/IFwiXCIsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5ncmFudFJlYWQocnNzSW5nZXN0b3JGdW5jdGlvbik7XG4gICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKFxuICAgICAgcnNzSW5nZXN0b3JGdW5jdGlvblxuICAgICk7XG4gICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLmdyYW50UmVhZERhdGEocnNzSW5nZXN0b3JGdW5jdGlvbik7XG5cbiAgICBjb25zdCB0cmlnZ2VyUnNzSW5nZXN0b3JzRnVuY3Rpb24gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIFwidHJpZ2dlclJzc0luZ2VzdG9yc0Z1bmN0aW9uXCIsXG4gICAgICB7XG4gICAgICAgIGNvZGU6IHByb3BzLnNoYXJlZC5zaGFyZWRDb2RlLmJ1bmRsZVdpdGhMYW1iZGFBc3NldChcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4vZnVuY3Rpb25zL3RyaWdnZXItcnNzLWluZ2VzdG9yc1wiKVxuICAgICAgICApLFxuICAgICAgICBkZXNjcmlwdGlvbjogXCJJbnZva2VzIFJTUyBGZWVkIEluZ2VzdG9ycyBmb3IgZWFjaCBTdWJzY3JpYmVkIFJTUyBGZWVkXCIsXG4gICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMuc2hhcmVkLmxhbWJkYUFyY2hpdGVjdHVyZSxcbiAgICAgICAgcnVudGltZTogcHJvcHMuc2hhcmVkLnB5dGhvblJ1bnRpbWUsXG4gICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgICAgaGFuZGxlcjogXCJpbmRleC5sYW1iZGFfaGFuZGxlclwiLFxuICAgICAgICBsYXllcnM6IFtwcm9wcy5zaGFyZWQucG93ZXJUb29sc0xheWVyLCBwcm9wcy5zaGFyZWQuY29tbW9uTGF5ZXJdLFxuICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygxNSksXG4gICAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLk9ORV9XRUVLLFxuICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgIC4uLnByb3BzLnNoYXJlZC5kZWZhdWx0RW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgICAgICAgQ09ORklHX1BBUkFNRVRFUl9OQU1FOiBwcm9wcy5zaGFyZWQuY29uZmlnUGFyYW1ldGVyLnBhcmFtZXRlck5hbWUsXG4gICAgICAgICAgV09SS1NQQUNFU19UQUJMRV9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICBXT1JLU1BBQ0VTX0JZX09CSkVDVF9UWVBFX0lOREVYX05BTUU6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy53b3Jrc3BhY2VzQnlPYmplY3RUeXBlSW5kZXhOYW1lLFxuICAgICAgICAgIERPQ1VNRU5UU19UQUJMRV9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzVGFibGUudGFibGVOYW1lID8/IFwiXCIsXG4gICAgICAgICAgRE9DVU1FTlRTX0JZX0NPTVBPVU5EX0tFWV9JTkRFWF9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzQnlDb21wb3VuZEtleUluZGV4TmFtZSA/PyBcIlwiLFxuICAgICAgICAgIERPQ1VNRU5UU19CWV9TVEFUVVNfSU5ERVg6XG4gICAgICAgICAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy5kb2N1bWVudHNCeVN0YXR1c0luZGV4TmFtZSA/PyBcIlwiLFxuICAgICAgICAgIFBST0NFU1NJTkdfQlVDS0VUX05BTUU6IHByb3BzLnByb2Nlc3NpbmdCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgICBSU1NfRkVFRF9JTkdFU1RPUl9GVU5DVElPTjogcnNzSW5nZXN0b3JGdW5jdGlvbi5mdW5jdGlvbk5hbWUsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIHJzc0luZ2VzdG9yRnVuY3Rpb24uZ3JhbnRJbnZva2UodHJpZ2dlclJzc0luZ2VzdG9yc0Z1bmN0aW9uKTtcbiAgICBwcm9wcy5zaGFyZWQuY29uZmlnUGFyYW1ldGVyLmdyYW50UmVhZCh0cmlnZ2VyUnNzSW5nZXN0b3JzRnVuY3Rpb24pO1xuXG4gICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzVGFibGUuZ3JhbnRSZWFkRGF0YShcbiAgICAgIHRyaWdnZXJSc3NJbmdlc3RvcnNGdW5jdGlvblxuICAgICk7XG5cbiAgICBuZXcgZXZlbnRzLlJ1bGUodGhpcywgXCJ0cmlnZ2VyUnNzSW5nZXN0b3JzRnVuY3Rpb25TY2hlZHVsZVwiLCB7XG4gICAgICBzY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlLnJhdGUoY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpKSxcbiAgICAgIHRhcmdldHM6IFtuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbih0cmlnZ2VyUnNzSW5nZXN0b3JzRnVuY3Rpb24pXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGNyYXdsUXVldWVkUnNzUG9zdHNGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJjcmF3bFF1ZXVlZFJzc1Bvc3RzRnVuY3Rpb25cIixcbiAgICAgIHtcbiAgICAgICAgdnBjOiBwcm9wcy5zaGFyZWQudnBjLFxuICAgICAgICBkZXNjcmlwdGlvbjpcbiAgICAgICAgICBcIkZ1bmN0aW9ucyBwb2xscyB0aGUgUlNTIGl0ZW1zIGZvciBwZW5kaW5nIHVybHMgYW5kIGludm9rZXMgV2Vic2l0ZSBjcmF3bGVyIGluZmVyZW5jZS4gTWF4IG9mIDEwIFVSTHMgcGVyIGludm9rZS5cIixcbiAgICAgICAgY29kZTogcHJvcHMuc2hhcmVkLnNoYXJlZENvZGUuYnVuZGxlV2l0aExhbWJkYUFzc2V0KFxuICAgICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi9mdW5jdGlvbnMvYmF0Y2gtY3Jhd2wtcnNzLXBvc3RzXCIpXG4gICAgICAgICksXG4gICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMuc2hhcmVkLmxhbWJkYUFyY2hpdGVjdHVyZSxcbiAgICAgICAgcnVudGltZTogcHJvcHMuc2hhcmVkLnB5dGhvblJ1bnRpbWUsXG4gICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgICAgaGFuZGxlcjogXCJpbmRleC5sYW1iZGFfaGFuZGxlclwiLFxuICAgICAgICBsYXllcnM6IFtwcm9wcy5zaGFyZWQucG93ZXJUb29sc0xheWVyLCBwcm9wcy5zaGFyZWQuY29tbW9uTGF5ZXJdLFxuICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAuLi5wcm9wcy5zaGFyZWQuZGVmYXVsdEVudmlyb25tZW50VmFyaWFibGVzLFxuICAgICAgICAgIENPTkZJR19QQVJBTUVURVJfTkFNRTogcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5wYXJhbWV0ZXJOYW1lLFxuICAgICAgICAgIFdPUktTUEFDRVNfVEFCTEVfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgV09SS1NQQUNFU19CWV9PQkpFQ1RfVFlQRV9JTkRFWF9OQU1FOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMud29ya3NwYWNlc0J5T2JqZWN0VHlwZUluZGV4TmFtZSxcbiAgICAgICAgICBET0NVTUVOVFNfVEFCTEVfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c1RhYmxlLnRhYmxlTmFtZSA/PyBcIlwiLFxuICAgICAgICAgIERPQ1VNRU5UU19CWV9DT01QT1VORF9LRVlfSU5ERVhfTkFNRTpcbiAgICAgICAgICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLmRvY3VtZW50c0J5Q29tcG91bmRLZXlJbmRleE5hbWUgPz8gXCJcIixcbiAgICAgICAgICBET0NVTUVOVFNfQllfU1RBVFVTX0lOREVYOlxuICAgICAgICAgICAgcHJvcHMucmFnRHluYW1vREJUYWJsZXMuZG9jdW1lbnRzQnlTdGF0dXNJbmRleE5hbWUgPz8gXCJcIixcbiAgICAgICAgICBXRUJTSVRFX0NSQVdMSU5HX1dPUktGTE9XX0FSTjpcbiAgICAgICAgICAgIHByb3BzLndlYnNpdGVDcmF3bGVyU3RhdGVNYWNoaW5lLnN0YXRlTWFjaGluZUFybixcbiAgICAgICAgICBQUk9DRVNTSU5HX0JVQ0tFVF9OQU1FOiBwcm9wcy5wcm9jZXNzaW5nQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIHByb3BzLnByb2Nlc3NpbmdCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoY3Jhd2xRdWV1ZWRSc3NQb3N0c0Z1bmN0aW9uKTtcbiAgICBwcm9wcy53ZWJzaXRlQ3Jhd2xlclN0YXRlTWFjaGluZS5ncmFudFN0YXJ0RXhlY3V0aW9uKFxuICAgICAgY3Jhd2xRdWV1ZWRSc3NQb3N0c0Z1bmN0aW9uXG4gICAgKTtcbiAgICBuZXcgZXZlbnRzLlJ1bGUodGhpcywgXCJDcmF3bFF1ZXVlZFJzc1Bvc3RzU2NoZWR1bGVSdWxlXCIsIHtcbiAgICAgIHNjaGVkdWxlOiBldmVudHMuU2NoZWR1bGUucmF0ZShjZGsuRHVyYXRpb24ubWludXRlcygxMCkpLFxuICAgICAgdGFyZ2V0czogW25ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGNyYXdsUXVldWVkUnNzUG9zdHNGdW5jdGlvbildLFxuICAgIH0pO1xuXG4gICAgcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5ncmFudFJlYWQoY3Jhd2xRdWV1ZWRSc3NQb3N0c0Z1bmN0aW9uKTtcbiAgICBwcm9wcy5yYWdEeW5hbW9EQlRhYmxlcy5kb2N1bWVudHNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoXG4gICAgICBjcmF3bFF1ZXVlZFJzc1Bvc3RzRnVuY3Rpb25cbiAgICApO1xuICAgIHByb3BzLnJhZ0R5bmFtb0RCVGFibGVzLndvcmtzcGFjZXNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoXG4gICAgICBjcmF3bFF1ZXVlZFJzc1Bvc3RzRnVuY3Rpb25cbiAgICApO1xuICB9XG59XG4iXX0=