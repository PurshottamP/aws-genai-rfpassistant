"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LangChainInterface = void 0;
const cdk = require("aws-cdk-lib");
const iam = require("aws-cdk-lib/aws-iam");
const lambda = require("aws-cdk-lib/aws-lambda");
const lambdaEventSources = require("aws-cdk-lib/aws-lambda-event-sources");
const logs = require("aws-cdk-lib/aws-logs");
const sqs = require("aws-cdk-lib/aws-sqs");
const constructs_1 = require("constructs");
const path = require("path");
class LangChainInterface extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const requestHandler = new lambda.Function(this, "RequestHandler", {
            vpc: props.shared.vpc,
            code: props.shared.sharedCode.bundleWithLambdaAsset(path.join(__dirname, "./functions/request-handler")),
            handler: "index.handler",
            runtime: props.shared.pythonRuntime,
            architecture: props.shared.lambdaArchitecture,
            tracing: lambda.Tracing.ACTIVE,
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            logRetention: logs.RetentionDays.ONE_WEEK,
            layers: [props.shared.powerToolsLayer, props.shared.commonLayer],
            environment: {
                ...props.shared.defaultEnvironmentVariables,
                CONFIG_PARAMETER_NAME: props.shared.configParameter.parameterName,
                COMPANY_PARAMETER_NAME: props.shared.companyParameter.parameterName,
                SESSIONS_TABLE_NAME: props.sessionsTable.tableName,
                QUESTIONS_TABLE_NAME: props.questionsTable.tableName,
                QUESTIONS_BY_SESSION_INDEX_NAME: props.bySessionIdIndex,
                CHATBOT_FILES_BUCKET_NAME: props.filesBucket.bucketName,
                API_KEYS_SECRETS_ARN: props.shared.apiKeysSecret.secretArn,
                MESSAGES_TOPIC_ARN: props.messagesTopic.topicArn,
                WORKSPACES_TABLE_NAME: props.ragEngines?.workspacesTable.tableName ?? "",
                WORKSPACES_BY_OBJECT_TYPE_INDEX_NAME: props.ragEngines?.workspacesByObjectTypeIndexName ?? "",
                AURORA_DB_SECRET_ID: props.ragEngines?.auroraPgVector?.database?.secret
                    ?.secretArn,
                SAGEMAKER_RAG_MODELS_ENDPOINT: props.ragEngines?.sageMakerRagModels?.model.endpoint
                    ?.attrEndpointName ?? "",
                OPEN_SEARCH_COLLECTION_ENDPOINT: props.ragEngines?.openSearchVector?.openSearchCollectionEndpoint ??
                    "",
                DEFAULT_KENDRA_INDEX_ID: props.ragEngines?.kendraRetrieval?.kendraIndex?.attrId ?? "",
                DEFAULT_KENDRA_INDEX_NAME: props.ragEngines?.kendraRetrieval?.kendraIndex?.name ?? "",
                DEFAULT_KENDRA_S3_DATA_SOURCE_ID: props.ragEngines?.kendraRetrieval?.kendraS3DataSource?.attrId ?? "",
                DEFAULT_KENDRA_S3_DATA_SOURCE_BUCKET_NAME: props.ragEngines?.kendraRetrieval?.kendraS3DataSourceBucket
                    ?.bucketName ?? "",
            },
        });
        if (props.config.bedrock?.enabled) {
            requestHandler.addToRolePolicy(new iam.PolicyStatement({
                actions: [
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream",
                ],
                resources: ["*"],
            }));
            if (props.config.bedrock?.roleArn) {
                requestHandler.addToRolePolicy(new iam.PolicyStatement({
                    actions: ["sts:AssumeRole"],
                    resources: [props.config.bedrock.roleArn],
                }));
            }
        }
        if (props.ragEngines?.auroraPgVector) {
            props.ragEngines?.auroraPgVector.database.secret?.grantRead(requestHandler);
            props.ragEngines?.auroraPgVector.database.connections.allowDefaultPortFrom(requestHandler);
        }
        if (props.ragEngines?.openSearchVector) {
            requestHandler.addToRolePolicy(new iam.PolicyStatement({
                actions: ["aoss:APIAccessAll"],
                resources: [
                    props.ragEngines?.openSearchVector.openSearchCollection.attrArn,
                ],
            }));
            props.ragEngines.openSearchVector.addToAccessPolicy("request-handler-langchain", [requestHandler.role?.roleArn], ["aoss:ReadDocument", "aoss:WriteDocument"]);
        }
        if (props.ragEngines) {
            props.ragEngines.workspacesTable.grantReadWriteData(requestHandler);
            props.ragEngines.documentsTable.grantReadWriteData(requestHandler);
        }
        if (props.ragEngines?.sageMakerRagModels) {
            requestHandler.addToRolePolicy(new iam.PolicyStatement({
                actions: ["sagemaker:InvokeEndpoint"],
                resources: [props.ragEngines.sageMakerRagModels.model.endpoint.ref],
            }));
        }
        if (props.ragEngines?.kendraRetrieval) {
            props.ragEngines?.kendraRetrieval?.kendraS3DataSourceBucket?.grantRead(requestHandler);
            if (props.ragEngines.kendraRetrieval.kendraIndex) {
                requestHandler.addToRolePolicy(new iam.PolicyStatement({
                    actions: ["kendra:Retrieve", "kendra:Query"],
                    resources: [props.ragEngines.kendraRetrieval.kendraIndex.attrArn],
                }));
            }
            for (const item of props.config.rag.engines.kendra.external || []) {
                if (item.roleArn) {
                    requestHandler.addToRolePolicy(new iam.PolicyStatement({
                        actions: ["sts:AssumeRole"],
                        resources: [item.roleArn],
                    }));
                }
                else {
                    requestHandler.addToRolePolicy(new iam.PolicyStatement({
                        actions: ["kendra:Retrieve", "kendra:Query"],
                        resources: [
                            `arn:${cdk.Aws.PARTITION}:kendra:${item.region ?? cdk.Aws.REGION}:${cdk.Aws.ACCOUNT_ID}:index/${item.kendraId}`,
                        ],
                    }));
                }
            }
        }
        props.sessionsTable.grantReadWriteData(requestHandler);
        props.questionsTable.grantReadWriteData(requestHandler);
        props.filesBucket.grantReadWrite(requestHandler);
        props.messagesTopic.grantPublish(requestHandler);
        props.shared.apiKeysSecret.grantRead(requestHandler);
        props.shared.configParameter.grantRead(requestHandler);
        props.shared.companyParameter.grantRead(requestHandler);
        // Add Amazon Bedrock permissions to the IAM role for the Lambda function
        requestHandler.addToRolePolicy(new iam.PolicyStatement({
            actions: ["bedrock:*", "bedrock:InvokeModelWithResponseStream"],
            resources: ["*"],
        }));
        requestHandler.addToRolePolicy(new iam.PolicyStatement({
            actions: [
                "comprehend:DetectDominantLanguage",
                "comprehend:DetectSentiment",
            ],
            resources: ["*"],
        }));
        const deadLetterQueue = new sqs.Queue(this, "DLQ", {
            enforceSSL: true,
        });
        const queue = new sqs.Queue(this, "Queue", {
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            // https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html#events-sqs-queueconfig
            visibilityTimeout: cdk.Duration.minutes(15 * 6),
            deadLetterQueue: {
                queue: deadLetterQueue,
                maxReceiveCount: 3,
            },
            enforceSSL: true,
        });
        queue.addToResourcePolicy(new iam.PolicyStatement({
            actions: ["sqs:SendMessage"],
            resources: [queue.queueArn],
            principals: [
                new iam.ServicePrincipal("events.amazonaws.com"),
                new iam.ServicePrincipal("sqs.amazonaws.com"),
            ],
        }));
        requestHandler.addEventSource(new lambdaEventSources.SqsEventSource(queue));
        this.ingestionQueue = queue;
        this.requestHandler = requestHandler;
    }
    addSageMakerEndpoint({ endpoint, name, }) {
        this.requestHandler.addToRolePolicy(new iam.PolicyStatement({
            actions: ["sagemaker:InvokeEndpoint"],
            resources: [endpoint.ref],
        }));
        const cleanName = name.replace(/[\s.\-_]/g, "").toUpperCase();
        this.requestHandler.addEnvironment(`SAGEMAKER_ENDPOINT_${cleanName}`, endpoint.attrEndpointName);
    }
}
exports.LangChainInterface = LangChainInterface;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFFbkMsMkNBQTJDO0FBQzNDLGlEQUFpRDtBQUNqRCwyRUFBMkU7QUFDM0UsNkNBQTZDO0FBSTdDLDJDQUEyQztBQUMzQywyQ0FBdUM7QUFDdkMsNkJBQTZCO0FBaUI3QixNQUFhLGtCQUFtQixTQUFRLHNCQUFTO0lBSS9DLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBOEI7UUFDdEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLGNBQWMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ2pFLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUc7WUFDckIsSUFBSSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSw2QkFBNkIsQ0FBQyxDQUNwRDtZQUNELE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU8sRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLGFBQWE7WUFDbkMsWUFBWSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsa0JBQWtCO1lBQzdDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDOUIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLEVBQUUsSUFBSTtZQUNoQixZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRO1lBQ3pDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO1lBQ2hFLFdBQVcsRUFBRTtnQkFDWCxHQUFHLEtBQUss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dCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxvZ3NcIjtcbmltcG9ydCB7IENmbkVuZHBvaW50IH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zYWdlbWFrZXJcIjtcbmltcG9ydCAqIGFzIHNucyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNuc1wiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3FzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgUmFnRW5naW5lcyB9IGZyb20gXCIuLi8uLi9yYWctZW5naW5lc1wiO1xuaW1wb3J0IHsgU2hhcmVkIH0gZnJvbSBcIi4uLy4uL3NoYXJlZFwiO1xuaW1wb3J0IHsgU3lzdGVtQ29uZmlnIH0gZnJvbSBcIi4uLy4uL3NoYXJlZC90eXBlc1wiO1xuaW1wb3J0IHsgTmFnU3VwcHJlc3Npb25zIH0gZnJvbSBcImNkay1uYWdcIjtcblxuaW50ZXJmYWNlIExhbmdDaGFpbkludGVyZmFjZVByb3BzIHtcbiAgcmVhZG9ubHkgc2hhcmVkOiBTaGFyZWQ7XG4gIHJlYWRvbmx5IGNvbmZpZzogU3lzdGVtQ29uZmlnO1xuICByZWFkb25seSByYWdFbmdpbmVzPzogUmFnRW5naW5lcztcbiAgcmVhZG9ubHkgbWVzc2FnZXNUb3BpYzogc25zLlRvcGljO1xuICByZWFkb25seSBzZXNzaW9uc1RhYmxlOiBkeW5hbW9kYi5UYWJsZTtcbiAgcmVhZG9ubHkgcXVlc3Rpb25zVGFibGU6IGR5bmFtb2RiLlRhYmxlO1xuICByZWFkb25seSBieVNlc3Npb25JZEluZGV4OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGZpbGVzQnVja2V0OiBzMy5CdWNrZXQ7XG59XG5cbmV4cG9ydCBjbGFzcyBMYW5nQ2hhaW5JbnRlcmZhY2UgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgaW5nZXN0aW9uUXVldWU6IHNxcy5RdWV1ZTtcbiAgcHVibGljIHJlYWRvbmx5IHJlcXVlc3RIYW5kbGVyOiBsYW1iZGEuRnVuY3Rpb247XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IExhbmdDaGFpbkludGVyZmFjZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJlcXVlc3RIYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlJlcXVlc3RIYW5kbGVyXCIsIHtcbiAgICAgIHZwYzogcHJvcHMuc2hhcmVkLnZwYyxcbiAgICAgIGNvZGU6IHByb3BzLnNoYXJlZC5zaGFyZWRDb2RlLmJ1bmRsZVdpdGhMYW1iZGFBc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuL2Z1bmN0aW9ucy9yZXF1ZXN0LWhhbmRsZXJcIilcbiAgICAgICksXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IHByb3BzLnNoYXJlZC5weXRob25SdW50aW1lLFxuICAgICAgYXJjaGl0ZWN0dXJlOiBwcm9wcy5zaGFyZWQubGFtYmRhQXJjaGl0ZWN0dXJlLFxuICAgICAgdHJhY2luZzogbGFtYmRhLlRyYWNpbmcuQUNUSVZFLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLk9ORV9XRUVLLFxuICAgICAgbGF5ZXJzOiBbcHJvcHMuc2hhcmVkLnBvd2VyVG9vbHNMYXllciwgcHJvcHMuc2hhcmVkLmNvbW1vbkxheWVyXSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIC4uLnByb3BzLnNoYXJlZC5kZWZhdWx0RW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgICAgIENPTkZJR19QQVJBTUVURVJfTkFNRTogcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5wYXJhbWV0ZXJOYW1lLFxuICAgICAgICBDT01QQU5ZX1BBUkFNRVRFUl9OQU1FOiBwcm9wcy5zaGFyZWQuY29tcGFueVBhcmFtZXRlci5wYXJhbWV0ZXJOYW1lLFxuICAgICAgICBTRVNTSU9OU19UQUJMRV9OQU1FOiBwcm9wcy5zZXNzaW9uc1RhYmxlLnRhYmxlTmFtZSwgICAgICBcbiAgICAgICAgUVVFU1RJT05TX1RBQkxFX05BTUU6IHByb3BzLnF1ZXN0aW9uc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgUVVFU1RJT05TX0JZX1NFU1NJT05fSU5ERVhfTkFNRTogcHJvcHMuYnlTZXNzaW9uSWRJbmRleCwgICAgICAgICBcbiAgICAgICAgQ0hBVEJPVF9GSUxFU19CVUNLRVRfTkFNRTogcHJvcHMuZmlsZXNCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgQVBJX0tFWVNfU0VDUkVUU19BUk46IHByb3BzLnNoYXJlZC5hcGlLZXlzU2VjcmV0LnNlY3JldEFybixcbiAgICAgICAgTUVTU0FHRVNfVE9QSUNfQVJOOiBwcm9wcy5tZXNzYWdlc1RvcGljLnRvcGljQXJuLFxuICAgICAgICBXT1JLU1BBQ0VTX1RBQkxFX05BTUU6XG4gICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8ud29ya3NwYWNlc1RhYmxlLnRhYmxlTmFtZSA/PyBcIlwiLFxuICAgICAgICBXT1JLU1BBQ0VTX0JZX09CSkVDVF9UWVBFX0lOREVYX05BTUU6XG4gICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8ud29ya3NwYWNlc0J5T2JqZWN0VHlwZUluZGV4TmFtZSA/PyBcIlwiLFxuICAgICAgICBBVVJPUkFfREJfU0VDUkVUX0lEOiBwcm9wcy5yYWdFbmdpbmVzPy5hdXJvcmFQZ1ZlY3Rvcj8uZGF0YWJhc2U/LnNlY3JldFxuICAgICAgICAgID8uc2VjcmV0QXJuIGFzIHN0cmluZyxcbiAgICAgICAgU0FHRU1BS0VSX1JBR19NT0RFTFNfRU5EUE9JTlQ6XG4gICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8uc2FnZU1ha2VyUmFnTW9kZWxzPy5tb2RlbC5lbmRwb2ludFxuICAgICAgICAgICAgPy5hdHRyRW5kcG9pbnROYW1lID8/IFwiXCIsXG4gICAgICAgIE9QRU5fU0VBUkNIX0NPTExFQ1RJT05fRU5EUE9JTlQ6XG4gICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8ub3BlblNlYXJjaFZlY3Rvcj8ub3BlblNlYXJjaENvbGxlY3Rpb25FbmRwb2ludCA/P1xuICAgICAgICAgIFwiXCIsXG4gICAgICAgIERFRkFVTFRfS0VORFJBX0lOREVYX0lEOlxuICAgICAgICAgIHByb3BzLnJhZ0VuZ2luZXM/LmtlbmRyYVJldHJpZXZhbD8ua2VuZHJhSW5kZXg/LmF0dHJJZCA/PyBcIlwiLFxuICAgICAgICBERUZBVUxUX0tFTkRSQV9JTkRFWF9OQU1FOlxuICAgICAgICAgIHByb3BzLnJhZ0VuZ2luZXM/LmtlbmRyYVJldHJpZXZhbD8ua2VuZHJhSW5kZXg/Lm5hbWUgPz8gXCJcIixcbiAgICAgICAgREVGQVVMVF9LRU5EUkFfUzNfREFUQV9TT1VSQ0VfSUQ6XG4gICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8ua2VuZHJhUmV0cmlldmFsPy5rZW5kcmFTM0RhdGFTb3VyY2U/LmF0dHJJZCA/PyBcIlwiLFxuICAgICAgICBERUZBVUxUX0tFTkRSQV9TM19EQVRBX1NPVVJDRV9CVUNLRVRfTkFNRTpcbiAgICAgICAgICBwcm9wcy5yYWdFbmdpbmVzPy5rZW5kcmFSZXRyaWV2YWw/LmtlbmRyYVMzRGF0YVNvdXJjZUJ1Y2tldFxuICAgICAgICAgICAgPy5idWNrZXROYW1lID8/IFwiXCIsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKHByb3BzLmNvbmZpZy5iZWRyb2NrPy5lbmFibGVkKSB7XG4gICAgICByZXF1ZXN0SGFuZGxlci5hZGRUb1JvbGVQb2xpY3koXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICBcImJlZHJvY2s6SW52b2tlTW9kZWxcIixcbiAgICAgICAgICAgIFwiYmVkcm9jazpJbnZva2VNb2RlbFdpdGhSZXNwb25zZVN0cmVhbVwiLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgaWYgKHByb3BzLmNvbmZpZy5iZWRyb2NrPy5yb2xlQXJuKSB7XG4gICAgICAgIHJlcXVlc3RIYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbXCJzdHM6QXNzdW1lUm9sZVwiXSxcbiAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLmNvbmZpZy5iZWRyb2NrLnJvbGVBcm5dLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLnJhZ0VuZ2luZXM/LmF1cm9yYVBnVmVjdG9yKSB7XG4gICAgICBwcm9wcy5yYWdFbmdpbmVzPy5hdXJvcmFQZ1ZlY3Rvci5kYXRhYmFzZS5zZWNyZXQ/LmdyYW50UmVhZChcbiAgICAgICAgcmVxdWVzdEhhbmRsZXJcbiAgICAgICk7XG4gICAgICBwcm9wcy5yYWdFbmdpbmVzPy5hdXJvcmFQZ1ZlY3Rvci5kYXRhYmFzZS5jb25uZWN0aW9ucy5hbGxvd0RlZmF1bHRQb3J0RnJvbShcbiAgICAgICAgcmVxdWVzdEhhbmRsZXJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLnJhZ0VuZ2luZXM/Lm9wZW5TZWFyY2hWZWN0b3IpIHtcbiAgICAgIHJlcXVlc3RIYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcImFvc3M6QVBJQWNjZXNzQWxsXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgICAgcHJvcHMucmFnRW5naW5lcz8ub3BlblNlYXJjaFZlY3Rvci5vcGVuU2VhcmNoQ29sbGVjdGlvbi5hdHRyQXJuLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBwcm9wcy5yYWdFbmdpbmVzLm9wZW5TZWFyY2hWZWN0b3IuYWRkVG9BY2Nlc3NQb2xpY3koXG4gICAgICAgIFwicmVxdWVzdC1oYW5kbGVyLWxhbmdjaGFpblwiLFxuICAgICAgICBbcmVxdWVzdEhhbmRsZXIucm9sZT8ucm9sZUFybl0sXG4gICAgICAgIFtcImFvc3M6UmVhZERvY3VtZW50XCIsIFwiYW9zczpXcml0ZURvY3VtZW50XCJdXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5yYWdFbmdpbmVzKSB7XG4gICAgICBwcm9wcy5yYWdFbmdpbmVzLndvcmtzcGFjZXNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEocmVxdWVzdEhhbmRsZXIpO1xuICAgICAgcHJvcHMucmFnRW5naW5lcy5kb2N1bWVudHNUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEocmVxdWVzdEhhbmRsZXIpO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5yYWdFbmdpbmVzPy5zYWdlTWFrZXJSYWdNb2RlbHMpIHtcbiAgICAgIHJlcXVlc3RIYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcInNhZ2VtYWtlcjpJbnZva2VFbmRwb2ludFwiXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtwcm9wcy5yYWdFbmdpbmVzLnNhZ2VNYWtlclJhZ01vZGVscy5tb2RlbC5lbmRwb2ludC5yZWZdLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMucmFnRW5naW5lcz8ua2VuZHJhUmV0cmlldmFsKSB7XG4gICAgICBwcm9wcy5yYWdFbmdpbmVzPy5rZW5kcmFSZXRyaWV2YWw/LmtlbmRyYVMzRGF0YVNvdXJjZUJ1Y2tldD8uZ3JhbnRSZWFkKFxuICAgICAgICByZXF1ZXN0SGFuZGxlclxuICAgICAgKTtcblxuICAgICAgaWYgKHByb3BzLnJhZ0VuZ2luZXMua2VuZHJhUmV0cmlldmFsLmtlbmRyYUluZGV4KSB7XG4gICAgICAgIHJlcXVlc3RIYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBhY3Rpb25zOiBbXCJrZW5kcmE6UmV0cmlldmVcIiwgXCJrZW5kcmE6UXVlcnlcIl0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFtwcm9wcy5yYWdFbmdpbmVzLmtlbmRyYVJldHJpZXZhbC5rZW5kcmFJbmRleC5hdHRyQXJuXSxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcHJvcHMuY29uZmlnLnJhZy5lbmdpbmVzLmtlbmRyYS5leHRlcm5hbCB8fCBbXSkge1xuICAgICAgICBpZiAoaXRlbS5yb2xlQXJuKSB7XG4gICAgICAgICAgcmVxdWVzdEhhbmRsZXIuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJzdHM6QXNzdW1lUm9sZVwiXSxcbiAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbaXRlbS5yb2xlQXJuXSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXF1ZXN0SGFuZGxlci5hZGRUb1JvbGVQb2xpY3koXG4gICAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgIGFjdGlvbnM6IFtcImtlbmRyYTpSZXRyaWV2ZVwiLCBcImtlbmRyYTpRdWVyeVwiXSxcbiAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgICAgICAgYGFybjoke2Nkay5Bd3MuUEFSVElUSU9OfTprZW5kcmE6JHtcbiAgICAgICAgICAgICAgICAgIGl0ZW0ucmVnaW9uID8/IGNkay5Bd3MuUkVHSU9OXG4gICAgICAgICAgICAgICAgfToke2Nkay5Bd3MuQUNDT1VOVF9JRH06aW5kZXgvJHtpdGVtLmtlbmRyYUlkfWAsXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBwcm9wcy5zZXNzaW9uc1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShyZXF1ZXN0SGFuZGxlcik7XG4gICAgcHJvcHMucXVlc3Rpb25zVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHJlcXVlc3RIYW5kbGVyKTtcbiAgICBwcm9wcy5maWxlc0J1Y2tldC5ncmFudFJlYWRXcml0ZShyZXF1ZXN0SGFuZGxlcik7XG4gICAgcHJvcHMubWVzc2FnZXNUb3BpYy5ncmFudFB1Ymxpc2gocmVxdWVzdEhhbmRsZXIpO1xuICAgIHByb3BzLnNoYXJlZC5hcGlLZXlzU2VjcmV0LmdyYW50UmVhZChyZXF1ZXN0SGFuZGxlcik7XG4gICAgcHJvcHMuc2hhcmVkLmNvbmZpZ1BhcmFtZXRlci5ncmFudFJlYWQocmVxdWVzdEhhbmRsZXIpO1xuICAgIHByb3BzLnNoYXJlZC5jb21wYW55UGFyYW1ldGVyLmdyYW50UmVhZChyZXF1ZXN0SGFuZGxlcik7XG5cbiAgICAvLyBBZGQgQW1hem9uIEJlZHJvY2sgcGVybWlzc2lvbnMgdG8gdGhlIElBTSByb2xlIGZvciB0aGUgTGFtYmRhIGZ1bmN0aW9uXG4gICAgcmVxdWVzdEhhbmRsZXIuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbXCJiZWRyb2NrOipcIiwgXCJiZWRyb2NrOkludm9rZU1vZGVsV2l0aFJlc3BvbnNlU3RyZWFtXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXF1ZXN0SGFuZGxlci5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcImNvbXByZWhlbmQ6RGV0ZWN0RG9taW5hbnRMYW5ndWFnZVwiLFxuICAgICAgICAgIFwiY29tcHJlaGVuZDpEZXRlY3RTZW50aW1lbnRcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgZGVhZExldHRlclF1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIkRMUVwiLCB7XG4gICAgICBlbmZvcmNlU1NMOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcXVldWUgPSBuZXcgc3FzLlF1ZXVlKHRoaXMsIFwiUXVldWVcIiwge1xuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIC8vIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9sYW1iZGEvbGF0ZXN0L2RnL3dpdGgtc3FzLmh0bWwjZXZlbnRzLXNxcy1xdWV1ZWNvbmZpZ1xuICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1ICogNiksXG4gICAgICBkZWFkTGV0dGVyUXVldWU6IHtcbiAgICAgICAgcXVldWU6IGRlYWRMZXR0ZXJRdWV1ZSxcbiAgICAgICAgbWF4UmVjZWl2ZUNvdW50OiAzLFxuICAgICAgfSxcbiAgICAgIGVuZm9yY2VTU0w6IHRydWUsXG4gICAgfSk7XG5cbiAgICBxdWV1ZS5hZGRUb1Jlc291cmNlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbXCJzcXM6U2VuZE1lc3NhZ2VcIl0sXG4gICAgICAgIHJlc291cmNlczogW3F1ZXVlLnF1ZXVlQXJuXSxcbiAgICAgICAgcHJpbmNpcGFsczogW1xuICAgICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImV2ZW50cy5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcInNxcy5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmVxdWVzdEhhbmRsZXIuYWRkRXZlbnRTb3VyY2UobmV3IGxhbWJkYUV2ZW50U291cmNlcy5TcXNFdmVudFNvdXJjZShxdWV1ZSkpO1xuXG4gICAgdGhpcy5pbmdlc3Rpb25RdWV1ZSA9IHF1ZXVlO1xuICAgIHRoaXMucmVxdWVzdEhhbmRsZXIgPSByZXF1ZXN0SGFuZGxlcjtcbiAgfVxuXG4gIHB1YmxpYyBhZGRTYWdlTWFrZXJFbmRwb2ludCh7XG4gICAgZW5kcG9pbnQsXG4gICAgbmFtZSxcbiAgfToge1xuICAgIGVuZHBvaW50OiBDZm5FbmRwb2ludDtcbiAgICBuYW1lOiBzdHJpbmc7XG4gIH0pIHtcbiAgICB0aGlzLnJlcXVlc3RIYW5kbGVyLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogW1wic2FnZW1ha2VyOkludm9rZUVuZHBvaW50XCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtlbmRwb2ludC5yZWZdLFxuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IGNsZWFuTmFtZSA9IG5hbWUucmVwbGFjZSgvW1xccy5cXC1fXS9nLCBcIlwiKS50b1VwcGVyQ2FzZSgpO1xuICAgIHRoaXMucmVxdWVzdEhhbmRsZXIuYWRkRW52aXJvbm1lbnQoXG4gICAgICBgU0FHRU1BS0VSX0VORFBPSU5UXyR7Y2xlYW5OYW1lfWAsXG4gICAgICBlbmRwb2ludC5hdHRyRW5kcG9pbnROYW1lXG4gICAgKTtcbiAgfVxufVxuIl19